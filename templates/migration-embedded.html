<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Hub - RDL Migration Tool</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuration Script -->
    <script>
        // Global configuration injected from Flask
        window.APP_CONFIG = {{ config | tojson }};
    </script>
    
    <!-- Embedded CSS for external access compatibility -->
    <style>
    :root {
        --primary-orange: #FF612B;
        --light-cream: #FAF8F2;
        --light-blue: #D9F6FA;
        --navy-blue: #002677;
        --dark-gray: #4B4D4F;
        --white: #FFFFFF;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, var(--light-cream) 0%, var(--light-blue) 100%);
        color: var(--navy-blue);
        min-height: 100vh;
    }

    .modern-nav {
        background: var(--white);
        border-bottom: 1px solid rgba(0, 38, 119, 0.1);
        padding: 1rem 0;
        margin-bottom: 2rem;
    }

    .nav-brand {
        color: var(--navy-blue);
        font-size: 1.5rem;
        font-weight: 700;
        text-decoration: none;
        display: flex;
        align-items: center;
    }

    .nav-brand:hover {
        color: var(--primary-orange);
        text-decoration: none;
    }

    .nav-links {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .nav-links a {
        color: var(--dark-gray);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-links a:hover {
        background: rgba(255, 97, 43, 0.1);
        color: var(--primary-orange);
    }

    .nav-links a.active {
        background: var(--primary-orange);
        color: var(--white);
    }

    /* Custom Alert System Styles */
    .custom-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .custom-alert-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .custom-alert {
        background: var(--white);
        border-radius: 20px;
        padding: 2rem;
        min-width: 400px;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        transform: scale(0.8) translateY(20px);
        transition: all 0.3s ease;
        position: relative;
        border: 1px solid rgba(0, 38, 119, 0.1);
    }

    .custom-alert-overlay.show .custom-alert {
        transform: scale(1) translateY(0);
    }

    .custom-alert.success {
        border-left: 6px solid #10b981;
    }

    .custom-alert.error {
        border-left: 6px solid #ef4444;
    }

    .custom-alert.warning {
        border-left: 6px solid var(--primary-orange);
    }

    .custom-alert.info {
        border-left: 6px solid var(--navy-blue);
    }

    .custom-alert-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .custom-alert-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.5rem;
    }

    .custom-alert.success .custom-alert-icon {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .custom-alert.error .custom-alert-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .custom-alert.warning .custom-alert-icon {
        background: rgba(255, 97, 43, 0.1);
        color: var(--primary-orange);
    }

    .custom-alert.info .custom-alert-icon {
        background: rgba(0, 38, 119, 0.1);
        color: var(--navy-blue);
    }

    .custom-alert-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--navy-blue);
        margin: 0;
    }

    .custom-alert-message {
        color: var(--dark-gray);
        line-height: 1.6;
        margin: 1rem 0 1.5rem 0;
        font-size: 1rem;
    }

    .custom-alert-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    .custom-alert-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        min-width: 80px;
    }

    .custom-alert-btn.primary {
        background: var(--primary-orange);
        color: var(--white);
        box-shadow: 0 4px 12px rgba(255, 97, 43, 0.3);
    }

    .custom-alert-btn.primary:hover {
        background: #e55527;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 97, 43, 0.4);
    }

    .custom-alert-btn.secondary {
        background: transparent;
        color: var(--dark-gray);
        border: 2px solid var(--light-cream);
    }

    .custom-alert-btn.secondary:hover {
        background: var(--light-cream);
        border-color: var(--primary-orange);
        color: var(--navy-blue);
    }

    .custom-alert-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--light-blue);
        border-radius: 8px;
        font-size: 1rem;
        margin: 1rem 0;
        transition: all 0.3s ease;
    }

    .custom-alert-input:focus {
        outline: none;
        border-color: var(--primary-orange);
        box-shadow: 0 0 0 3px rgba(255, 97, 43, 0.1);
    }

    /* Enhanced Toast notification styles for migration interface */
    .migration-toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }

    .migration-toast {
        background: var(--white);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        min-width: 300px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        transform: translateX(400px);
        transition: all 0.3s ease;
        border-left: 4px solid;
        position: relative;
        overflow: hidden;
    }

    .migration-toast.show {
        transform: translateX(0);
    }

    .migration-toast.success {
        border-left-color: #10b981;
    }

    .migration-toast.error {
        border-left-color: #ef4444;
    }

    .migration-toast.warning {
        border-left-color: var(--primary-orange);
    }

    .migration-toast.info {
        border-left-color: var(--navy-blue);
    }

    .migration-toast-content {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .migration-toast-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .migration-toast.success .migration-toast-icon {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .migration-toast.error .migration-toast-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .migration-toast.warning .migration-toast-icon {
        background: rgba(255, 97, 43, 0.1);
        color: var(--primary-orange);
    }

    .migration-toast.info .migration-toast-icon {
        background: rgba(0, 38, 119, 0.1);
        color: var(--navy-blue);
    }

    .migration-toast-text {
        flex: 1;
    }

    .migration-toast-title {
        font-weight: 600;
        color: var(--navy-blue);
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
    }

    .migration-toast-message {
        color: var(--dark-gray);
        font-size: 0.8rem;
        line-height: 1.4;
    }

    .migration-toast-close {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        color: var(--dark-gray);
        cursor: pointer;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.875rem;
        opacity: 0.6;
        transition: all 0.2s ease;
    }

    .migration-toast-close:hover {
        opacity: 1;
        background: rgba(0, 0, 0, 0.05);
    }

    .migration-toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: var(--primary-orange);
        width: 100%;
        transform-origin: left;
        animation: toast-progress 5s linear forwards;
    }

    @keyframes toast-progress {
        from { transform: scaleX(1); }
        to { transform: scaleX(0); }
    }

    /* Global Responsive Layout */
    .container {
        width: 100%;
        max-width: min(95vw, 1400px);
        margin: 0 auto;
        padding: 0 clamp(1rem, 3vw, 2rem);
        box-sizing: border-box;
    }

    /* Responsive Grid System */
    .responsive-grid {
        display: grid;
        gap: clamp(1rem, 2vw, 2rem);
    }

    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

    /* Mobile-first responsive breakpoints */
    @media (max-width: 480px) {
        .hero-title {
            font-size: clamp(1.5rem, 6vw, 2rem);
        }
        
        .nav-links {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn {
            width: 100%;
            max-width: 280px;
        }
        
        .modern-card {
            margin-bottom: 1rem;
        }
    }

    @media (min-width: 481px) and (max-width: 768px) {
        .grid-2, .grid-3, .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1025px) {
        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    /* Responsive Typography */
    h1 { font-size: clamp(1.8rem, 4vw, 2.5rem); }
    h2 { font-size: clamp(1.5rem, 3.5vw, 2rem); }
    h3 { font-size: clamp(1.3rem, 3vw, 1.75rem); }
    h4 { font-size: clamp(1.1rem, 2.5vw, 1.5rem); }
    h5 { font-size: clamp(1rem, 2vw, 1.25rem); }
    h6 { font-size: clamp(0.9rem, 1.8vw, 1.1rem); }

    p, span, div {
        font-size: clamp(0.875rem, 2vw, 1rem);
        line-height: 1.6;
    }

    /* SQL Modal Styles - Fully Responsive */
    .sql-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 99999;
        display: none;
        align-items: center;
        justify-content: center;
        padding: clamp(0.5rem, 2vw, 2rem);
        box-sizing: border-box;
        overflow-y: auto;
    }

    .sql-modal-container {
        background: #FFFFFF;
        border-radius: clamp(8px, 1vw, 16px);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.3);
        width: min(98vw, 95%);
        max-width: 1800px;
        height: min(95vh, 90%);
        max-height: 900px;
        min-height: clamp(400px, 70vh, 600px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: modalFadeIn 0.3s ease-out;
        position: relative;
        margin: auto;
    }

    /* Responsive breakpoints for modal */
    @media (max-width: 768px) {
        .sql-modal-overlay {
            padding: 0.25rem;
        }
        
        .sql-modal-container {
            width: 98vw;
            height: 96vh;
            border-radius: 8px;
            min-height: 85vh;
            max-height: none;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .sql-modal-container {
            width: 95vw;
            height: 92vh;
            min-height: 80vh;
            max-width: 1400px;
        }
    }

    @media (min-width: 1025px) {
        .sql-modal-container {
            width: 92vw;
            height: 88vh;
            max-width: 1800px;
            min-height: 75vh;
        }
    }

    @keyframes modalFadeIn {
        0% {
            opacity: 0;
            transform: scale(0.9) translateY(-50px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .sql-modal-header {
        background: linear-gradient(135deg, var(--navy-blue) 0%, #1a3a8a 100%);
        color: #FFFFFF;
        padding: clamp(1rem, 3vw, 2rem);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-bottom: clamp(2px, 0.3vw, 4px) solid var(--primary-orange);
        flex-wrap: wrap;
        gap: 1rem;
    }

    .sql-modal-title {
        margin: 0;
        font-size: clamp(1.1rem, 3vw, 1.5rem);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: clamp(0.5rem, 1vw, 0.75rem);
        flex: 1;
        min-width: 0;
    }

    .sql-modal-title i {
        color: var(--primary-orange);
    }

    .sql-modal-close {
        background: none;
        border: none;
        color: #FFFFFF;
        font-size: clamp(1.2rem, 3vw, 1.5rem);
        cursor: pointer;
        padding: clamp(0.4rem, 1vw, 0.6rem);
        border-radius: clamp(6px, 1vw, 8px);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: clamp(36px, 8vw, 44px);
        height: clamp(36px, 8vw, 44px);
        flex-shrink: 0;
    }

    .sql-modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
    }

    .sql-modal-content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: clamp(0.5rem, 2vw, 1rem);
        box-sizing: border-box;
    }

    /* Responsive modal content layout */
    @media (max-width: 768px) {
        .sql-modal-content {
            padding: 0.25rem;
        }
        
        .sql-modal-header {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
        }
        
        .sql-modal-title {
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .sql-modal-close {
            width: 32px;
            height: 32px;
            font-size: 1rem;
        }
        
        /* Stack SQL comparison panels vertically on mobile */
        .sql-modal-content div[style*="flex: 1; display: flex; overflow: hidden"] {
            flex-direction: column !important;
            gap: clamp(8px, 2vw, 12px) !important;
        }
        
        .sql-modal-content div[style*="flex: 1; display: flex; flex-direction: column; min-height: 0"] {
            flex: none !important;
            min-height: 40vh !important;
            max-height: 45vh !important;
        }
    }

    /* Mobile modal specific styles */
    @media (max-width: 480px) {
        .sql-modal-overlay {
            padding: 0;
        }
        
        .sql-modal-container {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            margin: 0;
        }
        
        .sql-modal-header {
            padding: 0.5rem 1rem;
        }
        
        .sql-modal-title {
            font-size: 1rem;
        }
        
        .sql-modal-close {
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
        }
    }

    .hero-section {
        text-align: center;
        padding: clamp(2rem, 5vw, 4rem) clamp(1rem, 3vw, 2rem);
        background: var(--white);
        border-radius: clamp(12px, 2vw, 24px);
        margin: clamp(1rem, 3vw, 2rem) auto;
        max-width: min(95vw, 1200px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 38, 119, 0.1);
    }

    .hero-title {
        background: linear-gradient(135deg, var(--navy-blue), var(--primary-orange));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: clamp(1.8rem, 5vw, 3rem);
        font-weight: 700;
        margin-bottom: clamp(1rem, 2vw, 1.5rem);
        line-height: 1.2;
    }

    .hero-subtitle {
        font-size: clamp(1rem, 2.5vw, 1.25rem);
        color: var(--dark-gray);
        max-width: min(90vw, 800px);
        margin: 0 auto clamp(1.5rem, 3vw, 2rem);
        line-height: 1.6;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: clamp(0.3rem, 1vw, 0.5rem);
        padding: clamp(0.75rem, 2vw, 1rem) clamp(1.5rem, 3vw, 2rem);
        border-radius: clamp(8px, 1.5vw, 12px);
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: clamp(0.9rem, 2vw, 1.1rem);
        justify-content: center;
        text-align: center;
        min-height: 44px; /* Minimum touch target size */
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-orange) 0%, #FF7A47 100%);
        color: var(--white);
        box-shadow: 0 4px 12px rgba(255, 97, 43, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 97, 43, 0.4);
        color: var(--white);
        text-decoration: none;
    }

    .btn-outline {
        background: transparent;
        color: var(--navy-blue);
        border: 2px solid var(--navy-blue);
    }

    .btn-outline:hover {
        background: var(--navy-blue);
        color: var(--white);
        text-decoration: none;
    }

    .btn-lg {
        padding: 1.25rem 2.5rem;
        font-size: 1.125rem;
        border-radius: 16px;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .btn-secondary {
        background: var(--white);
        color: var(--navy-blue);
        border: 2px solid rgba(0, 38, 119, 0.2);
    }

    .btn-secondary:hover {
        border-color: var(--primary-orange);
        color: var(--primary-orange);
    }

    .modern-card {
        background: var(--white);
        border-radius: clamp(12px, 2vw, 20px);
        padding: clamp(1.5rem, 3vw, 2rem);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 38, 119, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        margin-bottom: clamp(1.5rem, 3vw, 2rem);
        width: 100%;
        box-sizing: border-box;
    }

    .modern-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-orange), var(--navy-blue));
    }

    .modern-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 30px rgba(255, 97, 43, 0.1);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 38, 119, 0.1);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--navy-blue);
        margin: 0;
    }

    .card-icon {
        width: 24px;
        height: 24px;
        color: var(--primary-orange);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-info {
        background: rgba(59, 130, 246, 0.1);
        color: #3B82F6;
    }

    .status-success {
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }

    .status-warning {
        background: rgba(245, 158, 11, 0.1);
        color: #F59E0B;
    }

    .modern-upload {
        border: 2px dashed rgba(0, 38, 119, 0.2);
        border-radius: 24px;
        padding: 3rem;
        text-align: center;
        background: var(--white);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .modern-upload:hover {
        border-color: var(--primary-orange);
        transform: scale(1.02);
    }

    .modern-upload.dragover {
        border-color: var(--primary-orange);
        background: rgba(255, 97, 43, 0.05);
    }

    .upload-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, var(--primary-orange), #FF7A47);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 2rem;
    }

    .upload-text {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--navy-blue);
        margin-bottom: 0.5rem;
    }

    .upload-subtext {
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
    }

    .upload-specs {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: var(--dark-gray);
    }

    .upload-spec {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .modern-progress {
        background: rgba(0, 38, 119, 0.1);
        border-radius: 12px;
        overflow: hidden;
        height: 8px;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-orange), #FF7A47);
        border-radius: 12px;
        transition: width 0.4s ease;
        position: relative;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .modern-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--white);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }

    .modern-table th {
        background: var(--light-blue);
        padding: 1.5rem;
        text-align: left;
        font-weight: 600;
        color: var(--navy-blue);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .modern-table td {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(0, 38, 119, 0.1);
        vertical-align: middle;
    }

    .modern-table tr:hover {
        background: rgba(255, 97, 43, 0.05);
    }

    .modern-table tr:last-child td {
        border-bottom: none;
    }

    .grid {
        display: grid;
        gap: 2rem;
    }

    .grid-2 {
        grid-template-columns: repeat(2, 1fr);
    }

    .grid-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    @media (max-width: 768px) {
        .grid-2, .grid-3 {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: linear-gradient(135deg, var(--white) 0%, var(--light-cream) 100%);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid var(--light-blue);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-orange);
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--light-blue);
        border-top: 4px solid var(--primary-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none !important;
    }

    .flex {
        display: flex;
    }

    .items-center {
        align-items: center;
    }

    .justify-between {
        justify-content: space-between;
    }

    .justify-center {
        justify-content: center;
    }

    .gap-sm {
        gap: 0.5rem;
    }

    .gap-md {
        gap: 1rem;
    }

    .gap-lg {
        gap: 1.5rem;
    }

    .gap-xl {
        gap: 2rem;
    }

    .font-medium {
        font-weight: 500;
    }

    .font-semibold {
        font-weight: 600;
    }

    .text-center {
        text-align: center;
    }

    .text-gray {
        color: var(--dark-gray);
    }

    .mb-xs {
        margin-bottom: 0.25rem;
    }

    .mb-sm {
        margin-bottom: 0.5rem;
    }

    .mb-md {
        margin-bottom: 1rem;
    }

    .mb-lg {
        margin-bottom: 1.5rem;
    }

    .mb-xl {
        margin-bottom: 2rem;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .migration-option {
        border: 2px solid rgba(0, 38, 119, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .migration-option:hover {
        border-color: var(--primary-orange);
        background: rgba(255, 97, 43, 0.05);
    }

    .migration-option.selected {
        border-color: var(--primary-orange);
        background: rgba(255, 97, 43, 0.05);
    }

    .analysis-card {
        background: linear-gradient(135deg, var(--light-blue), rgba(255, 97, 43, 0.1));
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
    }

    .analysis-options {
        background: var(--white);
        border: 2px solid rgba(0, 38, 119, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
    }

    .option-item {
        margin-bottom: 1rem;
    }

    .option-item:last-child {
        margin-bottom: 0;
    }

    .progress-card {
        background: var(--white);
        border: 2px solid rgba(0, 38, 119, 0.1);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
    }

    .preview-card {
        background: var(--light-blue);
        border-radius: 20px;
        padding: 2rem;
    }

    .max-w-7xl {
        max-width: 1280px;
    }

    .mx-auto {
        margin-left: auto;
        margin-right: auto;
    }

    .px-6 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }
    </style>
</head>
<body>
    <!-- Modern Navigation -->
    <nav class="modern-nav">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex items-center justify-between">
                <a href="#" onclick="navigateTo('')" class="nav-brand">
                    <i class="fas fa-exchange-alt mr-2" style="color: var(--primary-orange);"></i>
                    RDL Migration Tool
                </a>
                <div class="nav-links">
                    <a href="#" onclick="navigateTo('')">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </a>
                    <a href="#" onclick="navigateTo('migration')" class="active">
                        <i class="fas fa-upload"></i>
                        Migration
                    </a>
                    <a href="#" onclick="navigateTo('results')">
                        <i class="fas fa-chart-line"></i>
                        Results
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6">

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="modern-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-cloud-upload-alt card-icon"></i>
                        Upload RDL Files
                    </h2>
                    <div class="status-badge status-info">
                        <i class="fas fa-shield-alt"></i>
                        <span>Secure Upload</span>
                    </div>
                </div>
                
                <!-- Modern File Drop Zone -->
                <div id="drop-zone" class="modern-upload">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drop your RDL files here</div>
                    <div class="upload-subtext">or click to browse and select files</div>
                    
                    <div class="upload-specs">
                        <div class="upload-spec">
                            <i class="fas fa-file-code" style="color: var(--primary-orange);"></i>
                            <span>Supports .rdl files</span>
                        </div>
                        <div class="upload-spec">
                            <i class="fas fa-layer-group" style="color: var(--primary-orange);"></i>
                            <span>Bulk upload enabled</span>
                        </div>
                        <div class="upload-spec">
                            <i class="fas fa-database" style="color: var(--primary-orange);"></i>
                            <span>Max 500MB total</span>
                        </div>
                        <div class="upload-spec">
                            <i class="fas fa-lock" style="color: var(--primary-orange);"></i>
                            <span>Secure & private</span>
                        </div>
                    </div>
                    
                    <input type="file" id="file-input" multiple accept=".rdl" style="display: none;">
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="hidden">
                    <div class="flex items-center justify-between mb-md" style="margin-top: 2rem;">
                        <div class="flex items-center gap-sm">
                            <i class="fas fa-upload" style="color: var(--primary-orange);"></i>
                            <span class="font-semibold">Uploading files...</span>
                        </div>
                        <span id="upload-percentage" class="status-badge status-info">0%</span>
                    </div>
                    <div class="modern-progress">
                        <div id="upload-progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- File List Section -->
        <section id="file-list-section" class="hidden">
            <div class="modern-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-list-ul card-icon"></i>
                        Uploaded Files
                    </h2>
                    <div class="flex items-center gap-md">
                        <button id="select-all-btn" class="btn btn-outline btn-sm">
                            <i class="fas fa-check-square"></i>
                            Select All
                        </button>
                        <button id="clear-files-btn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-trash"></i>
                            Clear All
                        </button>
                    </div>
                </div>
                
                <div id="file-table-container" style="overflow-x: auto;">
                    <!-- File table will be populated here -->
                </div>
                
                <!-- File Selection Summary -->
                <div id="selection-summary" class="hidden" style="
                    margin-top: 1.5rem;
                    padding: 1.5rem;
                    background: var(--light-blue);
                    border-radius: 12px;
                    text-align: center;
                ">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
                        <div class="flex items-center gap-sm">
                            <i class="fas fa-file-alt" style="color: var(--primary-orange);"></i>
                            <span id="selected-count" class="font-semibold">0</span>
                            <span class="text-gray">files selected</span>
                        </div>
                        <div class="flex items-center gap-sm">
                            <i class="fas fa-database" style="color: var(--primary-orange);"></i>
                            <span id="selected-size" class="font-semibold">0 MB</span>
                            <span class="text-gray">total size</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analysis Section -->
        <section id="analysis-section" class="hidden">
            <div class="modern-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-brain card-icon"></i>
                        AI-Powered Analysis
                    </h2>
                    <div class="status-badge status-warning">
                        <i class="fas fa-magic"></i>
                        <span>Business Logic</span>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <!-- Analysis Controls -->
                    <div>
                        <div class="analysis-card">
                            <div class="flex items-center justify-between mb-lg">
                                <div>
                                    <h3 style="color: var(--navy-blue); font-size: 1.25rem; margin-bottom: 0.5rem;">
                                        Similarity Analysis
                                    </h3>
                                    <p style="color: var(--dark-gray); margin: 0;">
                                        Identify duplicate reports and consolidation opportunities
                                    </p>
                                </div>
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    background: var(--white);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 1.25rem;
                                    color: var(--primary-orange);
                                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                                ">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                            
                            <button id="start-analysis-btn" class="btn btn-primary btn-lg" style="width: 100%;">
                                <i class="fas fa-play"></i>
                                Start Analysis
                            </button>
                        </div>
                        
                        <!-- Analysis Options -->
                        <div class="analysis-options">
                            <h4 style="margin-bottom: 1rem; color: var(--navy-blue);">Analysis Options</h4>
                            
                            <div class="option-item">
                                <label class="flex items-center gap-md cursor-pointer">
                                    <input type="checkbox" id="enable-consolidation" checked style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: var(--primary-orange);
                                    ">
                                    <div>
                                        <div class="font-medium">Smart Consolidation</div>
                                        <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                            AI-powered similarity recommendations
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="option-item">
                                <label class="flex items-center gap-md cursor-pointer">
                                    <input type="checkbox" id="deep-analysis" style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: var(--primary-orange);
                                    ">
                                    <div>
                                        <div class="font-medium">Deep Analysis</div>
                                        <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                            Advanced SQL pattern detection
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Progress -->
                    <div id="analysis-progress" class="hidden">
                        <div class="progress-card">
                            <div style="
                                width: 80px;
                                height: 80px;
                                border: 6px solid rgba(0, 38, 119, 0.1);
                                border-top: 6px solid var(--primary-orange);
                                border-radius: 50%;
                                margin: 0 auto 1.5rem;
                                animation: spin 1s linear infinite;
                            "></div>
                            
                            <h3 style="margin-bottom: 0.5rem;">AI Analysis in Progress</h3>
                            <p id="analysis-status" style="color: var(--dark-gray); margin-bottom: 1.5rem;">
                                Initializing business logic analyzer...
                            </p>
                            
                            <div class="flex items-center justify-between mb-sm">
                                <span class="font-medium">Progress</span>
                                <span id="analysis-percentage" class="status-badge status-info">0%</span>
                            </div>
                            <div class="modern-progress">
                                <div id="analysis-progress-bar" class="progress-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="hidden">
            <div class="modern-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-pie card-icon"></i>
                        Analysis Results
                    </h2>
                    <div class="status-badge status-success">
                        <i class="fas fa-check"></i>
                        <span>Complete</span>
                    </div>
                </div>
                
                <div id="results-content">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </section>

        <!-- Migration Section -->
        <section id="migration-section" class="hidden">
            <div class="modern-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-cogs card-icon"></i>
                        Migration Configuration
                    </h2>
                    <div class="status-badge status-info">
                        <i class="fas fa-settings"></i>
                        <span>Configure</span>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <!-- Migration Options -->
                    <div>
                        <h3 style="margin-bottom: 1.5rem;">Migration Mode</h3>
                        
                        <div class="migration-option" onclick="selectMigrationMode('individual')">
                            <label class="flex items-start gap-md cursor-pointer">
                                <input type="radio" name="migration-mode" value="individual" checked style="
                                    margin-top: 4px;
                                    width: 18px;
                                    height: 18px;
                                    accent-color: var(--primary-orange);
                                ">
                                <div>
                                    <div class="font-semibold mb-xs">Individual Migration</div>
                                    <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                        Each RDL file becomes a separate Power BI report
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="migration-option" onclick="selectMigrationMode('consolidated')">
                            <label class="flex items-start gap-md cursor-pointer">
                                <input type="radio" name="migration-mode" value="consolidated" style="
                                    margin-top: 4px;
                                    width: 18px;
                                    height: 18px;
                                    accent-color: var(--primary-orange);
                                ">
                                <div>
                                    <div class="font-semibold mb-xs">Smart Consolidation</div>
                                    <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                        Similar reports are merged into consolidated dashboards
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <button id="start-migration-btn" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 2rem;">
                            <i class="fas fa-rocket"></i>
                            Start Migration
                        </button>
                    </div>
                    
                    <!-- Migration Preview -->
                    <div>
                        <div class="preview-card">
                            <h4 style="margin-bottom: 1.5rem; color: var(--navy-blue);">
                                <i class="fas fa-eye" style="margin-right: 0.5rem;"></i>
                                Migration Preview
                            </h4>
                            
                            <div id="migration-summary">
                                <div class="text-center" style="color: var(--dark-gray);">
                                    Select files and configure options to see preview
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Dashboard (Hidden initially) -->
        <section id="progress-dashboard" class="hidden">
            <div style="background: #FFFFFF; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #D9F6FA;">
                    <h2 style="margin: 0; color: #002677; font-size: 1.5rem; font-weight: 600;">
                        <i class="fas fa-chart-line" style="margin-right: 0.5rem; color: #FF612B;"></i>
                        Migration Progress
                    </h2>
                    <div id="job-id-display" style="background: #FAF8F2; color: #4B4D4F; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; border: 2px solid #D9F6FA;">
                        <!-- Job ID will be shown here -->
                    </div>
                </div>
                
                <!-- Progress Status -->
                <div id="progress-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Progress cards will be populated here -->
                </div>
                
                <!-- Progress Bar -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; color: #002677; font-size: 1rem; font-weight: 600;">Overall Progress</h4>
                        <span id="progress-percentage" style="color: #FF612B; font-weight: 600;">0%</span>
                    </div>
                    <div style="background: #FAF8F2; height: 12px; border-radius: 6px; overflow: hidden; border: 2px solid #D9F6FA;">
                        <div id="progress-bar" style="background: #FF612B; height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
                    </div>
                    <div id="progress-details" style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: #4B4D4F;">
                        <span id="files-processed">0 of 0 files processed</span>
                        <span id="eta-display">Calculating...</span>
                    </div>
                </div>
                
                <!-- Current Activity -->
                <div id="current-activity" style="background: #D9F6FA; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #002677; font-size: 1rem; font-weight: 600;">
                        <i class="fas fa-cog fa-spin" style="margin-right: 0.5rem; color: #FF612B;"></i>
                        Current Activity
                    </h4>
                    <div id="current-file" style="color: #4B4D4F; font-weight: 600;">Initializing migration...</div>
                </div>
                
            </div>
        </section>

        <!-- Migration Results Section (Separate from Analysis) -->
        <section id="migration-results-section" class="hidden">
            <div style="background: #FFFFFF; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #D9F6FA;">
                    <h2 style="margin: 0; color: #002677; font-size: 1.5rem; font-weight: 600;">
                        <i class="fas fa-file-download" style="margin-right: 0.5rem; color: #FF612B;"></i>
                        Migration Results
                    </h2>
                    <div style="background: #D9F6FA; color: #002677; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; border: 2px solid #D9F6FA;">
                        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                        Complete
                    </div>
                </div>
                
                <div id="migration-results-content">
                    <!-- Migration results will be populated here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Embedded JavaScript -->
    <script>
    // Custom Alert System Class
    class CustomAlertSystem {
        constructor() {
            this.overlay = document.getElementById('custom-alert-overlay');
            this.alert = document.getElementById('custom-alert');
            this.icon = document.getElementById('custom-alert-icon-symbol');
            this.title = document.getElementById('custom-alert-title');
            this.message = document.getElementById('custom-alert-message');
            this.inputContainer = document.getElementById('custom-alert-input-container');
            this.input = document.getElementById('custom-alert-input');
            this.actions = document.getElementById('custom-alert-actions');
            this.cancelBtn = document.getElementById('custom-alert-cancel');
            this.confirmBtn = document.getElementById('custom-alert-confirm');
            this.toastContainer = document.getElementById('migration-toast-container');
            
            // Only bind events if elements exist
            if (this.overlay) {
                this.bindEvents();
            }
        }
        
        bindEvents() {
            // Close on overlay click
            if (this.overlay) {
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.close(false);
                    }
                });
            }
            
            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.overlay && this.overlay.classList.contains('show')) {
                    this.close(false);
                }
            });
            
            // Handle input enter key
            if (this.input) {
                this.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.close(this.input.value);
                    }
                });
            }
        }
        
        show(type, title, message, options = {}) {
            return new Promise((resolve) => {
                this.currentResolve = resolve;
                
                // Set alert type
                this.alert.className = `custom-alert ${type}`;
                
                // Set icon based on type
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-triangle',
                    warning: 'fas fa-exclamation-circle',
                    info: 'fas fa-info-circle'
                };
                this.icon.className = icons[type] || icons.info;
                
                // Set content
                this.title.textContent = title;
                this.message.textContent = message;
                
                // Handle different alert types
                if (options.type === 'confirm') {
                    this.cancelBtn.style.display = 'block';
                    this.confirmBtn.textContent = options.confirmText || 'Confirm';
                    this.cancelBtn.textContent = options.cancelText || 'Cancel';
                    this.inputContainer.style.display = 'none';
                } else if (options.type === 'prompt') {
                    this.cancelBtn.style.display = 'block';
                    this.confirmBtn.textContent = options.confirmText || 'OK';
                    this.cancelBtn.textContent = options.cancelText || 'Cancel';
                    this.inputContainer.style.display = 'block';
                    this.input.value = options.defaultValue || '';
                    this.input.placeholder = options.placeholder || 'Enter value...';
                } else {
                    this.cancelBtn.style.display = 'none';
                    this.confirmBtn.textContent = 'OK';
                    this.inputContainer.style.display = 'none';
                }
                
                // Bind button events
                this.cancelBtn.onclick = () => this.close(false);
                this.confirmBtn.onclick = () => {
                    if (options.type === 'prompt') {
                        this.close(this.input.value);
                    } else {
                        this.close(true);
                    }
                };
                
                // Show alert
                this.overlay.classList.add('show');
                
                // Focus input if prompt
                if (options.type === 'prompt') {
                    setTimeout(() => this.input.focus(), 300);
                }
            });
        }
        
        close(result) {
            this.overlay.classList.remove('show');
            if (this.currentResolve) {
                this.currentResolve(result);
                this.currentResolve = null;
            }
        }
        
        // Public API methods
        async alert(message, title = 'Alert') {
            return await this.show('info', title, message, { type: 'alert' });
        }
        
        async success(message, title = 'Success') {
            return await this.show('success', title, message, { type: 'alert' });
        }
        
        async error(message, title = 'Error') {
            return await this.show('error', title, message, { type: 'alert' });
        }
        
        async warning(message, title = 'Warning') {
            return await this.show('warning', title, message, { type: 'alert' });
        }
        
        async confirm(message, title = 'Confirm', options = {}) {
            return await this.show('warning', title, message, {
                type: 'confirm',
                confirmText: options.confirmText,
                cancelText: options.cancelText
            });
        }
        
        async prompt(message, title = 'Input Required', defaultValue = '', placeholder = '') {
            return await this.show('info', title, message, {
                type: 'prompt',
                defaultValue,
                placeholder
            });
        }
        
        // Enhanced Toast notifications for migration interface
        showToast(type, title, message, duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `migration-toast ${type}`;
            
            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation',
                info: 'fas fa-info'
            };
            
            toast.innerHTML = `
                <div class="migration-toast-content">
                    <div class="migration-toast-icon">
                        <i class="${icons[type] || icons.info}"></i>
                    </div>
                    <div class="migration-toast-text">
                        <div class="migration-toast-title">${title}</div>
                        <div class="migration-toast-message">${message}</div>
                    </div>
                </div>
                <button class="migration-toast-close">×</button>
                <div class="migration-toast-progress"></div>
            `;
            
            // Add close functionality
            const closeBtn = toast.querySelector('.migration-toast-close');
            closeBtn.addEventListener('click', () => {
                this.removeToast(toast);
            });
            
            // Add to container
            this.toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after duration
            setTimeout(() => {
                this.removeToast(toast);
            }, duration);
        }
        
        removeToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    }

    // Global alert system instance - initialize after DOM is ready
    let alertSystem = null;

    // Initialize alert system when DOM is ready
    function initializeAlertSystem() {
        if (!alertSystem) {
            alertSystem = new CustomAlertSystem();
            
            // Override native alert functions only if alert system is properly initialized
            if (alertSystem.overlay) {
                window.alert = (message) => alertSystem.alert(message);
                window.confirm = (message) => alertSystem.confirm(message);
                window.prompt = (message, defaultValue) => alertSystem.prompt(message, 'Input Required', defaultValue);
            }
        }
        return alertSystem;
    }

    class MigrationManager {
        constructor() {
            this.uploadedFiles = [];
            this.selectedFiles = [];
            this.analysisResults = null;
            this.currentJobId = null;
            this.uploadJobId = null;
            this.init();
        }
        
        init() {
            // Initialize alert system first
            initializeAlertSystem();
            this.setupFileUpload();
            this.setupEventListeners();
        }
        
        setupFileUpload() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            
            // Click to upload
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File selection
            fileInput.addEventListener('change', (e) => {
                this.handleFiles(e.target.files);
            });
            
            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                this.handleFiles(e.dataTransfer.files);
            });
        }
        
        setupEventListeners() {
            document.getElementById('select-all-btn').addEventListener('click', () => {
                this.selectAllFiles();
            });
            
            document.getElementById('clear-files-btn').addEventListener('click', () => {
                this.clearAllFiles();
            });
            
            document.getElementById('start-analysis-btn').addEventListener('click', () => {
                this.startAnalysis();
            });
            
            document.getElementById('start-migration-btn').addEventListener('click', () => {
                this.startMigration();
            });
        }
        
        handleFiles(files) {
            const validFiles = Array.from(files).filter(file => 
                file.name.toLowerCase().endsWith('.rdl')
            );
            
            if (validFiles.length === 0) {
                this.showToast('error', 'No valid RDL files selected', 'Please select .rdl files only');
                return;
            }
            
            this.uploadFiles(validFiles);
        }
        
        async uploadFiles(files) {
            const progressSection = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-percentage');
            
            try {
                progressSection.classList.remove('hidden');
                
                // Create FormData for actual server upload
                const formData = new FormData();
                files.forEach(file => {
                    formData.append('files', file);
                });
                
                // Update progress during upload
                progressBar.style.width = '50%';
                progressText.textContent = '50%';
                
                console.log(`[DEBUG] Uploading ${files.length} files to server...`);
                
                // Upload to server
                const response = await fetch(APP_CONFIG.apiUrls.upload, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('[DEBUG] Upload response:', result);
                
                // Store the upload job ID for preview functionality
                if (result.job_id) {
                    this.uploadJobId = result.job_id;
                    console.log('[DEBUG] Stored upload job ID:', this.uploadJobId);
                }
                
                // Update progress to 100%
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                
                // Store uploaded files with server response data
                this.uploadedFiles = [];
                if (result.files && Array.isArray(result.files)) {
                    // Use server response file data
                    result.files.forEach((serverFile, index) => {
                        this.uploadedFiles.push({
                            id: Date.now() + index,
                            name: serverFile.name,
                            size: serverFile.size,
                            path: serverFile.path, // Server file path
                            file: files[index], // Original file object for analysis
                            selected: true
                        });
                    });
                } else {
                    // Fallback: use original files if server doesn't return file list
                    files.forEach((file, index) => {
                        this.uploadedFiles.push({
                            id: Date.now() + index,
                            name: file.name,
                            size: file.size,
                            file: file,
                            selected: true
                        });
                    });
                }
                
                setTimeout(() => {
                    progressSection.classList.add('hidden');
                    this.updateFileList();
                    this.showFileListSection();
                    
                    // Show success notification with server response
                    const message = result.message || `Successfully uploaded ${files.length} RDL files!`;
                    this.showSuccessNotification(message);
                }, 500);
                
            } catch (error) {
                console.error('[ERROR] File upload failed:', error);
                
                // Hide progress and show error
                progressSection.classList.add('hidden');
                
                this.showToast('error', 'Upload Failed', 
                    error.message || 'Failed to upload files to server. Please check your connection and try again.');
            }
        }
        
        updateFileList() {
            const container = document.getElementById('file-table-container');
            
            if (this.uploadedFiles.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">No files uploaded</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'modern-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-checkbox" ${this.allFilesSelected() ? 'checked' : ''}></th>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${this.uploadedFiles.map(file => `
                        <tr>
                            <td>
                                <input type="checkbox" class="file-checkbox" data-file-id="${file.id}" 
                                       ${file.selected ? 'checked' : ''}>
                            </td>
                            <td>
                                <div class="flex items-center gap-sm">
                                    <i class="fas fa-file-code" style="color: var(--primary-orange);"></i>
                                    ${file.name}
                                </div>
                            </td>
                            <td>${this.formatFileSize(file.size)}</td>
                            <td>
                                <span class="status-badge status-success">
                                    <i class="fas fa-check"></i>
                                    Ready
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="migrationManager.previewUploadedFile('${file.path}', '${file.name}')" 
                                            class="btn btn-primary btn-sm" title="Preview RDL file">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="migrationManager.removeFile(${file.id})" 
                                            class="btn btn-secondary btn-sm" title="Remove file">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
            
            // Setup checkbox listeners
            document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                this.selectAllFiles(e.target.checked);
            });
            
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    this.updateFileSelection();
                });
            });
            
            this.updateFileSelection();
        }
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        updateFileSelection() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const totalSize = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .reduce((sum, cb) => {
                    const fileId = parseInt(cb.dataset.fileId);
                    const file = this.uploadedFiles.find(f => f.id === fileId);
                    return sum + (file ? file.size : 0);
                }, 0);
            
            document.getElementById('selected-count').textContent = selectedCount;
            document.getElementById('selected-size').textContent = this.formatFileSize(totalSize);
            
            const summary = document.getElementById('selection-summary');
            if (selectedCount > 0) {
                summary.classList.remove('hidden');
                document.getElementById('analysis-section').classList.remove('hidden');
            } else {
                summary.classList.add('hidden');
                document.getElementById('analysis-section').classList.add('hidden');
            }
        }
        
        selectAllFiles(checked = true) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });
            this.updateFileSelection();
        }
        
        allFilesSelected() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            return Array.from(checkboxes).every(cb => cb.checked);
        }
        
        async clearAllFiles() {
            const confirmed = await initializeAlertSystem().confirm(
                'Are you sure you want to clear all uploaded files? This action cannot be undone.',
                'Clear All Files',
                { confirmText: 'Clear All', cancelText: 'Cancel' }
            );
            
            if (confirmed) {
                this.uploadedFiles = [];
                this.updateFileList();
                document.getElementById('file-list-section').classList.add('hidden');
                document.getElementById('analysis-section').classList.add('hidden');
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('migration-section').classList.add('hidden');
                
                initializeAlertSystem().showToast('success', 'Files Cleared', 'All uploaded files have been removed successfully');
            }
        }
        
        removeFile(fileId) {
            this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== fileId);
            this.updateFileList();
            
            if (this.uploadedFiles.length === 0) {
                document.getElementById('file-list-section').classList.add('hidden');
                document.getElementById('analysis-section').classList.add('hidden');
            }
        }
        
        showFileListSection() {
            document.getElementById('file-list-section').classList.remove('hidden');
            document.getElementById('analysis-section').classList.remove('hidden');
        }
        
        async startAnalysis() {
            const selectedFiles = this.getSelectedFiles();
            if (selectedFiles.length === 0) {
                this.showToast('warning', 'No files selected', 'Please select files to analyze');
                return;
            }
            
            if (selectedFiles.length < 2) {
                this.showToast('warning', 'Minimum 2 files required', 'Please select at least 2 files for similarity analysis');
                return;
            }
            
            const progressDiv = document.getElementById('analysis-progress');
            const progressBar = document.getElementById('analysis-progress-bar');
            const progressText = document.getElementById('analysis-percentage');
            const statusText = document.getElementById('analysis-status');
            
            progressDiv.classList.remove('hidden');
            
            try {
                // Prepare files data for API - Create temporary files for analysis
                const formData = new FormData();
                selectedFiles.forEach(fileData => {
                    if (fileData.file) {
                        formData.append('files', fileData.file);
                    }
                });
                
                // First upload files to get proper paths, then analyze
                statusText.textContent = 'Uploading files for analysis...';
                progressBar.style.width = '20%';
                progressText.textContent = '20%';
                
                const uploadResponse = await fetch(APP_CONFIG.apiUrls.upload, {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                console.log('[DEBUG] Upload result:', uploadResult);
                
                // Check for files in the response (server returns 'files', not 'uploaded_files')
                const serverFiles = uploadResult.files || [];
                if (serverFiles.length === 0) {
                    throw new Error('File upload failed for analysis - no files returned from server');
                }
                
                // Now prepare the files data with proper paths for analysis
                const filesData = serverFiles.map(file => ({
                    name: file.name,
                    path: file.path,
                    size: file.size
                }));
                
                // Call the real analysis API
                statusText.textContent = 'Starting AI-powered business logic analysis...';
                progressBar.style.width = '40%';
                progressText.textContent = '40%';
                
                const response = await fetch(APP_CONFIG.apiUrls.analyze, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: filesData
                    })
                });
                
                statusText.textContent = 'Processing analysis results...';
                progressBar.style.width = '80%';
                progressText.textContent = '80%';
                
                const result = await response.json();
                
                if (result.success && result.results) {
                    this.analysisResults = result.results;
                    
                    statusText.textContent = 'Analysis complete!';
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    
                    setTimeout(() => {
                        this.showDetailedAnalysisResults();
                    }, 500);
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                statusText.textContent = 'Analysis failed - using demo data';
                
                // Fallback to demo data for testing
                this.analysisResults = this.generateDemoAnalysisResults(selectedFiles);
                
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                
                setTimeout(() => {
                    this.showDetailedAnalysisResults();
                }, 500);
            }
        }
        
        showDetailedAnalysisResults() {
            document.getElementById('analysis-progress').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('migration-section').classList.remove('hidden');
            
            const resultsContent = document.getElementById('results-content');
            
            if (!this.analysisResults || !this.analysisResults.pairs) {
                resultsContent.innerHTML = '<div class="text-center" style="color: var(--dark-gray);">No analysis results available</div>';
                return;
            }
            
            const pairs = this.analysisResults.pairs;
            const totalFiles = this.analysisResults.total_files || pairs.length;
            const highSimilarityPairs = pairs.filter(p => p.similarity >= 70);
            const mediumSimilarityPairs = pairs.filter(p => p.similarity >= 40 && p.similarity < 70);
            const lowSimilarityPairs = pairs.filter(p => p.similarity < 40);
            
            resultsContent.innerHTML = `
                <!-- Analysis Report Header -->
                <div style="background: #002677; padding: 2rem; border-radius: 12px; color: #FFFFFF; margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 600;">
                        <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                        Analysis Report 154 - Smart Consolidation Results
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: #FF612B;">${totalFiles}</div>
                            <div style="opacity: 0.9;">Files Analyzed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: #FF612B;">${pairs.length}</div>
                            <div style="opacity: 0.9;">Comparisons Made</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: #FF612B;">${highSimilarityPairs.length}</div>
                            <div style="opacity: 0.9;">High Similarity Pairs</div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: #FFFFFF; padding: 1.5rem; border-radius: 8px; text-align: center; border: 2px solid #D9F6FA; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: 700; color: #002677; margin-bottom: 0.5rem;">${highSimilarityPairs.length}</div>
                        <div style="color: #4B4D4F; margin-bottom: 0.5rem; font-weight: 600;">High Similarity (≥70%)</div>
                        <div style="font-size: 0.875rem; color: #4B4D4F;">Strong consolidation candidates</div>
                    </div>
                    <div style="background: #FFFFFF; padding: 1.5rem; border-radius: 8px; text-align: center; border: 2px solid #FAF8F2; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: 700; color: #FF612B; margin-bottom: 0.5rem;">${mediumSimilarityPairs.length}</div>
                        <div style="color: #4B4D4F; margin-bottom: 0.5rem; font-weight: 600;">Medium Similarity (40-69%)</div>
                        <div style="font-size: 0.875rem; color: #4B4D4F;">Review for potential consolidation</div>
                    </div>
                    <div style="background: #FFFFFF; padding: 1.5rem; border-radius: 8px; text-align: center; border: 2px solid #FAF8F2; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: 700; color: #4B4D4F; margin-bottom: 0.5rem;">${lowSimilarityPairs.length}</div>
                        <div style="color: #4B4D4F; margin-bottom: 0.5rem; font-weight: 600;">Low Similarity (<40%)</div>
                        <div style="font-size: 0.875rem; color: #4B4D4F;">Maintain as separate reports</div>
                    </div>
                </div>
                
                <!-- Detailed Analysis Results -->
                <div style="background: #FFFFFF; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 2rem 0; color: #002677; font-size: 1.25rem; font-weight: 600;">
                        <i class="fas fa-microscope" style="margin-right: 0.5rem;"></i>
                        Detailed Similarity Analysis
                    </h4>
                    
                    <!-- Simple Tab Navigation -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; gap: 0; border-bottom: 3px solid #FAF8F2;">
                            <button class="tab-button active" data-tab="high-similarity" style="padding: 1rem 2rem; border: none; background: #002677; color: #FFFFFF; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0;">
                                High (${highSimilarityPairs.length})
                            </button>
                            <button class="tab-button" data-tab="medium-similarity" style="padding: 1rem 2rem; border: none; background: #FAF8F2; color: #4B4D4F; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0;">
                                Medium (${mediumSimilarityPairs.length})
                            </button>
                            <button class="tab-button" data-tab="low-similarity" style="padding: 1rem 2rem; border: none; background: #FAF8F2; color: #4B4D4F; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0;">
                                Low (${lowSimilarityPairs.length})
                            </button>
                        </div>
                    </div>
                    
                    <div id="high-similarity" class="tab-content">
                        ${this.renderSimplifiedSimilarityPairs(highSimilarityPairs, 'high')}
                    </div>
                    
                    <div id="medium-similarity" class="tab-content hidden">
                        ${this.renderSimplifiedSimilarityPairs(mediumSimilarityPairs, 'medium')}
                    </div>
                    
                    <div id="low-similarity" class="tab-content hidden">
                        ${this.renderSimplifiedSimilarityPairs(lowSimilarityPairs, 'low')}
                    </div>
                </div>
                
                <!-- MODAL MOVED TO BODY LEVEL FOR COMPLETE SEPARATION -->
            `;
            
            // Setup tab functionality
            this.setupAnalysisTabsLogic();
            this.updateMigrationPreview();
        }
        
        renderSimplifiedSimilarityPairs(pairs, category) {
            if (pairs.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: #4B4D4F;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; color: #4B4D4F;"></i>
                        <h4 style="margin: 0.5rem 0; color: #002677;">No ${category} similarity pairs found</h4>
                        <p style="margin: 0; color: #4B4D4F;">No file pairs match the ${category} similarity criteria.</p>
                    </div>
                `;
            }
            
            return pairs.map((pair, index) => `
                <div style="background: #FAF8F2; border: 2px solid #D9F6FA; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <!-- File Comparison Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #D9F6FA;">
                        <div>
                            <h5 style="margin: 0 0 0.5rem 0; color: #002677; font-size: 1.1rem; font-weight: 600;">
                                <i class="fas fa-files" style="margin-right: 0.5rem; color: #FF612B;"></i>
                                ${pair.file1} ↔ ${pair.file2}
                            </h5>
                            <div style="font-size: 0.875rem; color: #4B4D4F;">
                                Comparison ${index + 1} of ${pairs.length}
                            </div>
                        </div>
                        <div style="text-align: center; background: #FFFFFF; padding: 1rem; border-radius: 8px; border: 2px solid #D9F6FA;">
                            <div style="font-size: 2rem; font-weight: 700; color: #002677;">
                                ${pair.similarity}%
                            </div>
                            <div style="font-size: 0.875rem; color: #4B4D4F; font-weight: 600;">Overall Match</div>
                        </div>
                    </div>
                    
                    <!-- Business Logic Metrics -->
                    <div style="margin-bottom: 1.5rem;">
                        <h6 style="margin: 0 0 1rem 0; color: #002677; font-size: 1rem; font-weight: 600;">
                            <i class="fas fa-chart-bar" style="margin-right: 0.5rem; color: #FF612B;"></i>
                            Business Logic Analysis
                        </h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            ${this.renderSimplifiedMetrics(pair.details)}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="migrationManager.openSQLModal('${pair.file1}', '${pair.file2}', ${index})" style="background: #FF612B; color: #FFFFFF; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-code" style="margin-right: 0.5rem;"></i>
                            View SQL Queries
                        </button>
                        <button onclick="migrationManager.exportPairAnalysis(${index})" style="background: #FFFFFF; color: #002677; border: 2px solid #002677; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-download" style="margin-right: 0.5rem;"></i>
                            Export Analysis
                        </button>
                    </div>
                    
                    <!-- Recommendation Badge -->
                    <div style="margin-top: 1rem; text-align: center;">
                        ${this.renderRecommendationBadge(pair.similarity)}
                    </div>
                </div>
            `).join('');
        }
        
        renderSimplifiedMetrics(details) {
            const metrics = [
                { label: 'Data Source', value: details.data_source_similarity || 0, icon: 'fas fa-database' },
                { label: 'Filter Logic', value: details.filter_logic_similarity || 0, icon: 'fas fa-filter' },
                { label: 'Business Purpose', value: details.business_purpose_similarity || 0, icon: 'fas fa-bullseye' },
                { label: 'Calculations', value: details.calculation_similarity || 0, icon: 'fas fa-calculator' },
                { label: 'Parameters', value: details.parameter_similarity || 0, icon: 'fas fa-sliders-h' }
            ];
            
            return metrics.map(metric => `
                <div style="background: #FFFFFF; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #D9F6FA;">
                    <div style="color: #FF612B; font-size: 1.2rem; margin-bottom: 0.5rem;">
                        <i class="${metric.icon}"></i>
                    </div>
                    <div style="font-size: 0.875rem; color: #4B4D4F; margin-bottom: 0.5rem; font-weight: 600;">
                        ${metric.label}
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #002677;">
                        ${Math.round(metric.value)}%
                    </div>
                </div>
            `).join('');
        }
        
        renderRecommendationBadge(similarity) {
            let recommendation, bgColor, textColor;
            
            if (similarity >= 70) {
                recommendation = "✅ Recommend Consolidation";
                bgColor = "#D9F6FA";
                textColor = "#002677";
            } else if (similarity >= 40) {
                recommendation = "⚠️ Review for Consolidation";
                bgColor = "#FAF8F2";
                textColor = "#FF612B";
            } else {
                recommendation = "❌ Keep Separate";
                bgColor = "#FFFFFF";
                textColor = "#4B4D4F";
            }
            
            return `
                <div style="background: ${bgColor}; color: ${textColor}; padding: 0.75rem 1.5rem; border-radius: 20px; display: inline-block; font-weight: 600; font-size: 0.875rem;">
                    ${recommendation}
                </div>
            `;
        }
        
        renderSimilarityPairs(pairs, category) {
            if (pairs.length === 0) {
                return `
                    <div class="text-center" style="padding: 3rem; color: var(--dark-gray);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h4>No ${category} similarity pairs found</h4>
                        <p>No file pairs match the ${category} similarity criteria.</p>
                    </div>
                `;
            }
            
            return pairs.map((pair, index) => `
                <div class="similarity-pair-card modern-card" style="margin-bottom: 2rem; border-left: 4px solid ${this.getSimilarityColor(pair.similarity)};">
                    <!-- Pair Header -->
                    <div class="flex items-center justify-between mb-lg" style="border-bottom: 1px solid var(--light-blue); padding-bottom: 1rem;">
                        <div>
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--navy-blue);">
                                <i class="fas fa-copy" style="margin-right: 0.5rem;"></i>
                                ${pair.file1} ↔ ${pair.file2}
                            </h5>
                            <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                Comparison ${index + 1} of ${pairs.length}
                            </div>
                        </div>
                        <div class="similarity-score" style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: ${this.getSimilarityColor(pair.similarity)};">
                                ${pair.similarity}%
                            </div>
                            <div style="font-size: 0.875rem; color: var(--dark-gray);">Overall Similarity</div>
                        </div>
                    </div>
                    
                    <!-- Detailed Breakdown -->
                    <div class="similarity-breakdown grid grid-2" style="margin-bottom: 2rem; gap: 1rem;">
                        <div>
                            <h6 style="margin-bottom: 1rem; color: var(--navy-blue);">
                                <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                                Business Logic Breakdown
                            </h6>
                            ${this.renderSimilarityMetrics(pair.details)}
                        </div>
                        <div>
                            <h6 style="margin-bottom: 1rem; color: var(--navy-blue);">
                                <i class="fas fa-lightbulb" style="margin-right: 0.5rem;"></i>
                                Consolidation Recommendation
                            </h6>
                            ${this.renderConsolidationRecommendation(pair.similarity)}
                        </div>
                    </div>
                    
                    <!-- SQL Query Comparison -->
                    ${this.renderSQLComparison(pair, index)}
                    
                    <div class="flex justify-end gap-md" style="margin-top: 1.5rem;">
                        <button onclick="migrationManager.exportPairAnalysis(${index})" class="btn btn-outline btn-sm">
                            <i class="fas fa-download"></i>
                            Export Analysis
                        </button>
                        <button onclick="migrationManager.openSQLModal('${pair.file1}', '${pair.file2}', ${index})" class="btn btn-primary btn-sm">
                            <i class="fas fa-code"></i>
                            View SQL Queries
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        renderSimilarityMetrics(details) {
            const metrics = [
                { label: 'Data Source', value: details.data_source_similarity || 0, icon: 'fas fa-database' },
                { label: 'Filter Logic', value: details.filter_logic_similarity || 0, icon: 'fas fa-filter' },
                { label: 'Business Purpose', value: details.business_purpose_similarity || 0, icon: 'fas fa-bullseye' },
                { label: 'Calculations', value: details.calculation_similarity || 0, icon: 'fas fa-calculator' },
                { label: 'Parameters', value: details.parameter_similarity || 0, icon: 'fas fa-sliders-h' }
            ];
            
            return metrics.map(metric => `
                <div class="flex items-center justify-between mb-sm" style="padding: 0.5rem; background: var(--light-cream); border-radius: 8px; margin-bottom: 0.5rem;">
                    <div class="flex items-center gap-sm">
                        <i class="${metric.icon}" style="color: var(--primary-orange); width: 16px;"></i>
                        <span style="font-size: 0.875rem;">${metric.label}</span>
                    </div>
                    <div class="flex items-center gap-sm">
                        <div class="progress-mini" style="width: 60px; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${metric.value}%; height: 100%; background: ${this.getSimilarityColor(metric.value)}; transition: width 0.3s;"></div>
                        </div>
                        <span style="font-weight: 600; color: ${this.getSimilarityColor(metric.value)}; font-size: 0.875rem; min-width: 35px;">
                            ${Math.round(metric.value)}%
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        renderConsolidationRecommendation(similarity) {
            let recommendation, icon, color, action;
            
            if (similarity >= 70) {
                recommendation = "Strong consolidation candidate";
                icon = "fas fa-check-circle";
                color = "#10B981";
                action = "Merge these reports into a single consolidated dashboard";
            } else if (similarity >= 40) {
                recommendation = "Review for potential consolidation";
                icon = "fas fa-exclamation-triangle";
                color = "#F59E0B";
                action = "Manual review recommended to determine consolidation feasibility";
            } else {
                recommendation = "Maintain as separate reports";
                icon = "fas fa-times-circle";
                color = "#6B7280";
                action = "Keep these reports separate due to distinct business logic";
            }
            
            return `
                <div style="background: var(--light-cream); padding: 1rem; border-radius: 8px; border-left: 4px solid ${color};">
                    <div class="flex items-center gap-sm mb-sm">
                        <i class="${icon}" style="color: ${color};"></i>
                        <span class="font-semibold" style="color: ${color};">${recommendation}</span>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--dark-gray);">
                        ${action}
                    </div>
                </div>
            `;
        }
        
        renderSQLComparison(pair, pairIndex) {
            const file1Queries = pair.sql_queries?.file1_queries || [];
            const file2Queries = pair.sql_queries?.file2_queries || [];
            
            if (file1Queries.length === 0 && file2Queries.length === 0) {
                return `
                    <div class="sql-comparison" style="background: var(--light-cream); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--light-blue);">
                        <h6 style="margin-bottom: 1rem; color: var(--navy-blue);">
                            <i class="fas fa-code" style="margin-right: 0.5rem;"></i>
                            SQL Query Analysis
                        </h6>
                        <div class="text-center" style="color: var(--dark-gray); padding: 2rem;">
                            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No SQL queries found in the analyzed RDL files</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="sql-comparison" id="sql-comparison-${pairIndex}" style="background: var(--light-cream); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--light-blue);">
                    <!-- SQL Query Summary Header -->
                    <div class="sql-summary-header" style="margin-bottom: 1.5rem;">
                        <h6 style="margin-bottom: 1rem; color: var(--navy-blue);">
                            <i class="fas fa-code" style="margin-right: 0.5rem;"></i>
                            SQL Query Comparison - Manual Review
                        </h6>
                        
                        <div class="grid grid-2" style="gap: 1.5rem; margin-bottom: 1rem;">
                            <div style="background: var(--white); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-orange);">
                                <div class="flex items-center justify-between mb-sm">
                                    <div class="flex items-center gap-sm">
                                        <i class="fas fa-file-alt" style="color: var(--primary-orange);"></i>
                                        <span class="font-semibold" style="color: var(--navy-blue);">${pair.file1}</span>
                                    </div>
                                    <span style="background: var(--primary-orange); color: var(--white); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                        ${file1Queries.length} ${file1Queries.length === 1 ? 'Query' : 'Queries'}
                                    </span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                    Left side comparison queries
                                </div>
                            </div>
                            <div style="background: var(--white); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--navy-blue);">
                                <div class="flex items-center justify-between mb-sm">
                                    <div class="flex items-center gap-sm">
                                        <i class="fas fa-file-alt" style="color: var(--navy-blue);"></i>
                                        <span class="font-semibold" style="color: var(--navy-blue);">${pair.file2}</span>
                                    </div>
                                    <span style="background: var(--navy-blue); color: var(--white); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                        ${file2Queries.length} ${file2Queries.length === 1 ? 'Query' : 'Queries'}
                                    </span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                    Right side comparison queries
                                </div>
                            </div>
                        </div>
                        
                        <!-- Toggle Button for SQL Details -->
                        <div class="text-center">
                            <button onclick="migrationManager.openSQLModal('${pairs[pairIndex].file1}', '${pairs[pairIndex].file2}', ${pairIndex})" 
                                    id="sql-toggle-${pairIndex}" 
                                    class="btn btn-outline btn-sm" 
                                    style="background: var(--white); border: 2px solid var(--primary-orange); color: var(--primary-orange);">
                                <i class="fas fa-code" style="margin-right: 0.5rem;"></i>
                                View SQL Queries
                            </button>
                        </div>
                    </div>
                    
                    <!-- OLD inline SQL details completely removed - now using overlay modal only -->
                </div>
            `;
        }
        
        // OLD renderDetailedSQLQueries method REMOVED - now using overlay modal only
        
        // OLD inline SQL rendering methods REMOVED - now using overlay modal only
        
        setupAnalysisTabsLogic() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Update button states with new color scheme
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.background = '#FAF8F2';
                        btn.style.color = '#4B4D4F';
                    });
                    
                    button.classList.add('active');
                    button.style.background = '#002677';
                    button.style.color = '#FFFFFF';
                    
                    // Update content visibility
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    document.getElementById(targetTab).classList.remove('hidden');
                });
            });
        }
        
        openSQLModal(file1, file2, pairIndex) {
            console.log('Opening SQL Modal - NEW IMPLEMENTATION');
            
            // PREVENT any inline content from showing
            this.hideInlineAnalysisContent();
            
            const modal = document.getElementById('sql-query-modal');
            const modalContent = document.getElementById('sql-modal-content');
            
            if (!modal || !modalContent) {
                console.error('Modal elements not found');
                return;
            }
            
            // Get the pair data
            const pair = this.analysisResults.pairs[pairIndex];
            const file1Queries = pair.sql_queries?.file1_queries || [];
            const file2Queries = pair.sql_queries?.file2_queries || [];
            
            // Generate modal content with improved structure and better sizing
            modalContent.innerHTML = `
                <!-- Comparison Summary -->
                <div style="background: linear-gradient(135deg, var(--light-cream) 0%, var(--light-blue) 100%); padding: 1rem 1.5rem; border-bottom: 3px solid var(--primary-orange); flex-shrink: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="margin: 0; color: var(--navy-blue); font-size: 1.1rem; font-weight: 700;">
                            <i class="fas fa-exchange-alt" style="color: var(--primary-orange); margin-right: 0.5rem;"></i>
                            ${file1} ↔ ${file2}
                        </h4>
                        <div style="background: var(--white); padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid var(--primary-orange);">
                            <span style="color: var(--navy-blue); font-weight: 700; font-size: 0.9rem;">${pair.similarity}% Overall Match</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 2rem; font-size: 0.85rem; color: var(--dark-gray);">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-code" style="color: var(--primary-orange);"></i>
                            <strong>${file1Queries.length}</strong> queries in ${file1}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-code" style="color: var(--navy-blue);"></i>
                            <strong>${file2Queries.length}</strong> queries in ${file2}
                        </div>
                    </div>
                </div>
                
                <!-- SQL Queries Side by Side with Improved Layout -->
                <div style="flex: 1; display: flex; overflow: hidden; min-height: 0; gap: clamp(4px, 1vw, 8px); background: var(--light-cream); padding: clamp(0.25rem, 1vw, 0.5rem); border-radius: 8px; margin: clamp(0.5rem, 1vw, 1rem);">
                    <!-- Left Side -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; background: var(--white); border-radius: 8px; overflow: hidden; border: 1px solid var(--light-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="background: linear-gradient(135deg, var(--primary-orange) 0%, #FF7A47 100%); color: var(--white); padding: clamp(0.75rem, 2vw, 1.25rem); font-weight: 600; text-align: center; flex-shrink: 0; font-size: clamp(0.85rem, 1.8vw, 1.1rem); display: flex; align-items: center; justify-content: center; gap: 0.5rem; min-height: clamp(50px, 8vh, 60px);">
                            <i class="fas fa-file-alt" style="flex-shrink: 0;"></i>
                            <span style="flex: 1; min-width: 0; word-break: break-word; text-align: center; line-height: 1.2;" title="${file1}">${file1.length > 25 ? file1.substring(0, 22) + '...' : file1}</span>
                            <span style="background: rgba(255,255,255,0.25); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8em; flex-shrink: 0; font-weight: 700;">${file1Queries.length}</span>
                        </div>
                        <div style="flex: 1; overflow: auto; min-height: 0; background: var(--white);">
                            ${this.renderSQLQueriesInModal(file1Queries, 'left')}
                        </div>
                    </div>
                    
                    <!-- Right Side -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; background: var(--white); border-radius: 8px; overflow: hidden; border: 1px solid var(--light-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="background: linear-gradient(135deg, var(--navy-blue) 0%, #1a3a8a 100%); color: var(--white); padding: clamp(0.75rem, 2vw, 1.25rem); font-weight: 600; text-align: center; flex-shrink: 0; font-size: clamp(0.85rem, 1.8vw, 1.1rem); display: flex; align-items: center; justify-content: center; gap: 0.5rem; min-height: clamp(50px, 8vh, 60px);">
                            <i class="fas fa-file-alt" style="flex-shrink: 0;"></i>
                            <span style="flex: 1; min-width: 0; word-break: break-word; text-align: center; line-height: 1.2;" title="${file2}">${file2.length > 25 ? file2.substring(0, 22) + '...' : file2}</span>
                            <span style="background: rgba(255,255,255,0.25); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8em; flex-shrink: 0; font-weight: 700;">${file2Queries.length}</span>
                        </div>
                        <div style="flex: 1; overflow: auto; min-height: 0; background: var(--white);">
                            ${this.renderSQLQueriesInModal(file2Queries, 'right')}
                        </div>
                    </div>
                </div>
            `;
            
            // Lock body scroll to prevent conflicts
            document.body.style.overflow = 'hidden';
            
            // Show modal with proper display
            modal.style.display = 'flex';
            
            // Clean event listeners
            this.cleanupModalEvents();
            
            // Simple click outside to close
            this.modalClickHandler = (e) => {
                if (e.target === modal) {
                    this.closeSQLModal();
                }
            };
            modal.addEventListener('click', this.modalClickHandler);
            
            // Escape key to close
            this.modalKeyHandler = (e) => {
                if (e.key === 'Escape') {
                    this.closeSQLModal();
                }
            };
            document.addEventListener('keydown', this.modalKeyHandler);
        }
        
        hideInlineAnalysisContent() {
            // Hide any existing inline analysis content that might interfere
            const existingAnalysisSection = document.querySelector('[class*="sql"], [id*="sql"]:not(#sql-query-modal)');
            if (existingAnalysisSection && existingAnalysisSection.id !== 'sql-query-modal') {
                existingAnalysisSection.style.display = 'none';
            }
        }
        
        cleanupModalEvents() {
            const modal = document.getElementById('sql-query-modal');
            if (this.modalClickHandler) {
                modal.removeEventListener('click', this.modalClickHandler);
            }
            if (this.modalKeyHandler) {
                document.removeEventListener('keydown', this.modalKeyHandler);
            }
        }
        
        renderSQLQueriesInModal(queries, side) {
            if (queries.length === 0) {
                return `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--dark-gray); text-align: center; padding: clamp(1rem, 3vw, 2rem);">
                        <i class="fas fa-info-circle" style="font-size: clamp(2rem, 4vw, 3rem); margin-bottom: 1rem; opacity: 0.5; color: var(--primary-orange);"></i>
                        <h4 style="margin: 0.5rem 0; color: var(--navy-blue); font-size: clamp(1rem, 2vw, 1.25rem); font-weight: 600;">No SQL Queries Found</h4>
                        <p style="margin: 0; font-size: clamp(0.8rem, 1.5vw, 1rem); line-height: 1.5;">This RDL file doesn't contain extractable SQL queries.</p>
                    </div>
                `;
            }
            
            return `
                <div style="padding: clamp(0.75rem, 2.5vw, 1.25rem); height: 100%; box-sizing: border-box; overflow-y: auto;">
                    ${queries.map((query, index) => `
                        <div style="background: var(--light-cream); border: 1px solid var(--light-blue); border-radius: clamp(6px, 1vw, 8px); padding: clamp(1rem, 2.5vw, 1.25rem); margin-bottom: clamp(1rem, 2vw, 1.25rem); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; gap: clamp(0.5rem, 1.5vw, 1rem); flex-wrap: wrap;">
                                <h5 style="margin: 0; color: var(--navy-blue); font-size: clamp(0.95rem, 2vw, 1.1rem); font-weight: 700; flex: 1; min-width: 0; line-height: 1.3;">
                                    <i class="fas fa-database" style="color: var(--primary-orange); margin-right: 0.5rem; flex-shrink: 0;"></i>
                                    <span style="word-break: break-word; display: inline-block;">Query ${index + 1}: ${(query.dataset_name || 'Unknown Dataset').length > 20 ? (query.dataset_name || 'Unknown Dataset').substring(0, 17) + '...' : (query.dataset_name || 'Unknown Dataset')}</span>
                                </h5>
                                <div style="background: var(--primary-orange); color: var(--white); padding: clamp(0.3rem, 1vw, 0.5rem) clamp(0.5rem, 1.5vw, 0.75rem); border-radius: 4px; font-size: clamp(0.7rem, 1.3vw, 0.8rem); font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                                    ${query.query_type || 'SQL'}
                                </div>
                            </div>
                            
                            <div style="background: var(--white); border: 1px solid var(--navy-blue); border-radius: 6px; overflow: hidden; margin-bottom: 0.75rem;">
                                <pre style="margin: 0; padding: clamp(0.75rem, 2vw, 1rem); font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: clamp(0.75rem, 1.4vw, 0.85rem); line-height: 1.5; overflow-x: auto; color: var(--navy-blue); max-height: clamp(250px, 35vh, 350px); overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; background: var(--white); border: none;">${this.formatSQLForDisplay(query.sql_query)}</pre>
                            </div>
                            
                            ${query.parameters && query.parameters.length > 0 ? `
                                <div style="margin-top: 0.5rem;">
                                    <div style="font-size: clamp(0.7rem, 1.3vw, 0.8rem); color: var(--dark-gray); font-weight: 600; margin-bottom: 0.5rem;">
                                        <i class="fas fa-sliders-h" style="color: var(--primary-orange); margin-right: 0.25rem;"></i>
                                        Parameters:
                                    </div>
                                    <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                        ${query.parameters.map(param => `
                                            <span style="background: var(--navy-blue); color: var(--white); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: clamp(0.6rem, 1.1vw, 0.7rem); font-weight: 600; word-break: break-word;">
                                                ${param.length > 12 ? param.substring(0, 9) + '...' : param}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        formatSQLForDisplay(sqlQuery) {
            if (!sqlQuery || typeof sqlQuery !== 'string') {
                return 'No query available';
            }
            
            // Basic SQL formatting
            return sqlQuery
                .replace(/\bSELECT\b/gi, 'SELECT')
                .replace(/\bFROM\b/gi, 'FROM')
                .replace(/\bWHERE\b/gi, 'WHERE')
                .replace(/\bJOIN\b/gi, 'JOIN')
                .replace(/\bINNER JOIN\b/gi, 'INNER JOIN')
                .replace(/\bLEFT JOIN\b/gi, 'LEFT JOIN')
                .replace(/\bRIGHT JOIN\b/gi, 'RIGHT JOIN')
                .replace(/\bORDER BY\b/gi, 'ORDER BY')
                .replace(/\bGROUP BY\b/gi, 'GROUP BY')
                .replace(/\bHAVING\b/gi, 'HAVING')
                .trim();
        }
        
        closeSQLModal() {
            console.log('Closing SQL Modal - NEW IMPLEMENTATION');
            
            const modal = document.getElementById('sql-query-modal');
            if (!modal) return;
            
            // Clean up all event listeners first
            this.cleanupModalEvents();
            
            // Hide modal
            modal.style.display = 'none';
            
            // Restore body scroll
            document.body.style.overflow = '';
            
            // Show any hidden inline content again (cleanup)
            this.showInlineAnalysisContent();
            
            // Clear modal content to free memory
            const modalContent = document.getElementById('sql-modal-content');
            if (modalContent) {
                modalContent.innerHTML = '';
            }
        }
        
        showInlineAnalysisContent() {
            // Re-show any inline analysis content that was hidden
            const hiddenAnalysisElements = document.querySelectorAll('[class*="sql"], [id*="sql"]:not(#sql-query-modal)');
            hiddenAnalysisElements.forEach(element => {
                if (element.id !== 'sql-query-modal' && element.style.display === 'none') {
                    element.style.display = '';
                }
            });
        }
        
        startProgressPolling() {
            if (!this.currentJobId) return;
            
            console.log('[DEBUG] Starting progress polling for job:', this.currentJobId);
            
            // Initial progress setup
            this.updateProgressStatus({
                status: 'running',
                progress: 0,
                processed: 0,
                total: this.getSelectedFiles().length,
                message: 'Starting migration...'
            });
            
            // Start polling every 2 seconds
            this.progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${APP_CONFIG.apiUrls.progress}/${this.currentJobId}`);
                    const progressData = await response.json();
                    
                    console.log('[DEBUG] Progress update:', progressData);
                    console.log('[DEBUG] Progress data breakdown - processed:', progressData.processed, 'total:', progressData.total, 'progress:', progressData.progress);
                    
                    if (progressData.error) {
                        console.error('Progress error:', progressData.error);
                        this.stopProgressPolling();
                        return;
                    }
                    
                    this.updateProgressStatus(progressData);
                    
                    // Check if migration is complete
                    if (progressData.status === 'completed' || progressData.status === 'error') {
                        this.stopProgressPolling();
                        
                        if (progressData.status === 'completed') {
                            await this.fetchMigrationResults();
                        }
                    }
                    
                } catch (error) {
                    console.error('Progress polling error:', error);
                }
            }, 2000);
        }
        
        stopProgressPolling() {
            if (this.progressInterval) {
                clearInterval(this.progressInterval);
                this.progressInterval = null;
                console.log('[DEBUG] Progress polling stopped');
            }
        }
        
        updateProgressStatus(progressData) {
            // Handle completion state values
            const isCompleted = progressData.status === 'completed';
            const totalFiles = this.getSelectedFiles().length;
            
            // For completed jobs, use final values
            let displayProcessed, displayTotal, displayProgress;
            if (isCompleted) {
                displayProcessed = totalFiles;
                displayTotal = totalFiles;
                displayProgress = 100;
            } else {
                displayProcessed = progressData.processed || 0;
                displayTotal = progressData.total || totalFiles;
                displayProgress = progressData.progress || 0;
            }
            
            // Update progress cards
            const progressStatus = document.getElementById('progress-status');
            progressStatus.innerHTML = `
                <div style="background: #FAF8F2; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #D9F6FA;">
                    <div style="color: #FF612B; font-size: 1.2rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div style="font-size: 0.875rem; color: #4B4D4F; font-weight: 600; margin-bottom: 0.5rem;">Status</div>
                    <div style="font-size: 1rem; font-weight: 700; color: #002677; text-transform: uppercase;">
                        ${progressData.status || 'Running'}
                    </div>
                </div>
                
                <div style="background: #FAF8F2; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #D9F6FA;">
                    <div style="color: #FF612B; font-size: 1.2rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div style="font-size: 0.875rem; color: #4B4D4F; font-weight: 600; margin-bottom: 0.5rem;">Files Processed</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #002677;">
                        ${displayProcessed} / ${displayTotal}
                    </div>
                </div>
                
                <div style="background: #FAF8F2; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #D9F6FA;">
                    <div style="color: #FF612B; font-size: 1.2rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div style="font-size: 0.875rem; color: #4B4D4F; font-weight: 600; margin-bottom: 0.5rem;">Time Remaining</div>
                    <div style="font-size: 1rem; font-weight: 700; color: #002677;">
                        ${isCompleted ? 'Completed' : this.formatETA(progressData.eta_seconds)}
                    </div>
                </div>
                
                <div id="error-summary-card" style="background: #FAF8F2; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #D9F6FA; cursor: ${(progressData.errors || 0) > 0 ? 'pointer' : 'default'};" 
                     onclick="${(progressData.errors || 0) > 0 ? 'migrationApp.showErrorDetails()' : ''}" 
                     title="${(progressData.errors || 0) > 0 ? 'Click to view error details' : ''}">
                    <div style="color: #FF612B; font-size: 1.2rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div style="font-size: 0.875rem; color: #4B4D4F; font-weight: 600; margin-bottom: 0.5rem;">Errors</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: ${(progressData.errors || 0) > 0 ? '#FF612B' : '#002677'};">
                        ${progressData.errors || 0}
                    </div>
                    ${(progressData.errors || 0) > 0 ? '<div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem;">Click for details</div>' : ''}
                </div>
            `;
            
            // Update progress bar
            document.getElementById('progress-percentage').textContent = `${displayProgress}%`;
            document.getElementById('progress-bar').style.width = `${displayProgress}%`;
            
            // Update progress details
            document.getElementById('files-processed').textContent = 
                `${displayProcessed} of ${displayTotal} files processed`;
            document.getElementById('eta-display').textContent = isCompleted ? 'Completed' : this.formatETA(progressData.eta_seconds);
            
            // Update current activity
            const currentFile = document.getElementById('current-file');
            if (progressData.status === 'completed') {
                currentFile.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #10B981; margin-right: 0.5rem;"></i>
                    Migration completed successfully!
                `;
            } else if (progressData.status === 'error') {
                currentFile.innerHTML = `
                    <i class="fas fa-exclamation-circle" style="color: #EF4444; margin-right: 0.5rem;"></i>
                    Migration failed with errors
                `;
            } else if (progressData.message) {
                currentFile.innerHTML = `
                    <i class="fas fa-cog fa-spin" style="color: #FF612B; margin-right: 0.5rem;"></i>
                    ${progressData.message}
                `;
            }
        }
        
        formatETA(etaSeconds) {
            if (!etaSeconds || etaSeconds <= 0) return 'Calculating...';
            
            const minutes = Math.floor(etaSeconds / 60);
            const seconds = Math.floor(etaSeconds % 60);
            
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        async fetchMigrationResults() {
            try {
                console.log('[DEBUG] Fetching migration results for job:', this.currentJobId);
                
                const response = await fetch(`${APP_CONFIG.apiUrls.results}/${this.currentJobId}`);
                const resultsData = await response.json();
                
                console.log('[DEBUG] Migration results:', resultsData);
                
                if (resultsData.error) {
                    console.error('Results error:', resultsData.error);
                    return;
                }
                
                await this.displayMigrationResults(resultsData);
                
            } catch (error) {
                console.error('Error fetching migration results:', error);
            }
        }
        
        async displayMigrationResults(resultsData) {
            console.log('[DEBUG] Displaying migration results, showing section...');
            const resultsSection = document.getElementById('migration-results-section');
            const resultsContent = document.getElementById('migration-results-content');
            
            console.log('[DEBUG] Results section element:', resultsSection);
            console.log('[DEBUG] Results content element:', resultsContent);
            
            // Fetch detailed file list
            try {
                // Remove _migration suffix for results directory lookup
                const resultJobId = this.currentJobId.replace('_migration', '');
                const filesResponse = await fetch(`${APP_CONFIG.apiUrls.results}/${resultJobId}/files`);
                const filesData = await filesResponse.json();
                
                console.log('[DEBUG] Generated files:', filesData);
                console.log('[DEBUG] Files array:', filesData.files);
                console.log('[DEBUG] Files count:', filesData.files ? filesData.files.length : 'undefined');
                
                if (filesData.files && filesData.files.length > 0) {
                    console.log('[DEBUG] Rendering files with renderGeneratedFiles');
                    
                    // Store available files for context switching
                    this.availableFiles = filesData.files;
                    
                    const renderedHTML = this.renderGeneratedFiles(filesData.files);
                    console.log('[DEBUG] Rendered HTML length:', renderedHTML.length);
                    resultsContent.innerHTML = renderedHTML;
                } else {
                    console.log('[DEBUG] No files found, showing no files message');
                    resultsContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #4B4D4F;">
                            <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h4 style="margin: 0.5rem 0; color: #002677;">No files generated</h4>
                            <p style="margin: 0;">Migration completed but no output files were created.</p>
                        </div>
                    `;
                }
                
                console.log('[DEBUG] Showing migration results section...');
                resultsSection.classList.remove('hidden');
                
                // Scroll to results section
                resultsSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
            } catch (error) {
                console.error('Error fetching file list:', error);
                resultsContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #4B4D4F;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #FF612B;"></i>
                        <h4 style="margin: 0.5rem 0; color: #002677;">Error Loading Results</h4>
                        <p style="margin: 0;">Unable to fetch generated files. Please check the migration log.</p>
                    </div>
                `;
                resultsSection.classList.remove('hidden');
            }
        }
        
        renderGeneratedFiles(files) {
            // Group files by type
            const filesByType = files.reduce((acc, file) => {
                const ext = file.type || '.unknown';
                if (!acc[ext]) acc[ext] = [];
                acc[ext].push(file);
                return acc;
            }, {});
            
            let html = '';
            
            // Render each file type group
            Object.keys(filesByType).forEach(fileType => {
                const typeFiles = filesByType[fileType];
                const typeIcon = this.getFileTypeIcon(fileType);
                const typeLabel = this.getFileTypeLabel(fileType);
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #002677; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center;">
                            <i class="${typeIcon}" style="margin-right: 0.5rem; color: #FF612B;"></i>
                            ${typeLabel} (${typeFiles.length} files)
                        </h5>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            ${typeFiles.map(file => this.renderFileCard(file)).join('')}
                        </div>
                    </div>
                `;
            });
            
            // Add download all button
            html += `
                <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #D9F6FA;">
                    <button onclick="migrationManager.downloadAllResults()" style="background: #002677; color: #FFFFFF; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-download" style="margin-right: 0.5rem;"></i>
                        Download All Results (ZIP)
                    </button>
                </div>
            `;
            
            return html;
        }
        
        renderFileCard(file) {
            return `
                <div style="background: #FAF8F2; border: 2px solid #D9F6FA; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h6 style="margin: 0; color: #002677; font-weight: 600; font-size: 0.9rem; line-height: 1.2;">
                            ${file.name}
                        </h6>
                        <span style="background: #D9F6FA; color: #002677; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                            ${this.formatFileSize(file.size)}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 1rem; font-size: 0.875rem; color: #4B4D4F;">
                        Path: ${file.path}
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="migrationManager.previewFile('${file.path}')" style="background: #FF612B; color: #FFFFFF; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; flex: 1;">
                            <i class="fas fa-eye" style="margin-right: 0.25rem;"></i>
                            Preview
                        </button>
                        <button onclick="migrationManager.downloadFile('${file.path}', '${file.name}')" style="background: #FFFFFF; color: #002677; border: 2px solid #002677; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; flex: 1;">
                            <i class="fas fa-download" style="margin-right: 0.25rem;"></i>
                            Download
                        </button>
                    </div>
                </div>
            `;
        }
        
        getFileTypeIcon(fileType) {
            const icons = {
                '.m': 'fas fa-code',        // Power Query
                '.dax': 'fas fa-function',  // DAX
                '.md': 'fas fa-book',       // Migration Guide
                '.json': 'fas fa-file-code',
                '.txt': 'fas fa-file-alt',
                '.py': 'fas fa-code'
            };
            return icons[fileType] || 'fas fa-file';
        }
        
        getFileTypeLabel(fileType) {
            const labels = {
                '.m': 'Power Query Files',
                '.dax': 'DAX Files',
                '.md': 'Migration Guides',
                '.json': 'JSON Files',
                '.txt': 'Text Files',
                '.py': 'Python Files'
            };
            return labels[fileType] || 'Other Files';
        }
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        async downloadAllResults() {
            try {
                const resultJobId = this.currentJobId.replace('_migration', '');
                const link = document.createElement('a');
                link.href = `${APP_CONFIG.apiUrls.download}/${resultJobId}`;
                link.download = `migration_results_${resultJobId}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('success', 'Download Started', 'Downloading all migration results as ZIP file');
            } catch (error) {
                console.error('Download error:', error);
                this.showToast('error', 'Download Failed', 'Unable to download results');
            }
        }
        
        async downloadFile(filePath, fileName) {
            try {
                const resultJobId = this.currentJobId.replace('_migration', '');
                const link = document.createElement('a');
                link.href = `${APP_CONFIG.apiUrls.results}/${resultJobId}/download/${filePath}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('success', 'Download Started', `Downloading ${fileName}`);
            } catch (error) {
                console.error('Download error:', error);
                this.showToast('error', 'Download Failed', `Unable to download ${fileName}`);
            }
        }
        
        async previewFile(filePath, contextFile = null) {
            try {
                if (!this.currentJobId) {
                    this.showToast('error', 'Preview Error', 'No migration job selected for preview');
                    return;
                }
                
                const resultJobId = this.currentJobId.replace('_migration', '');
                
                // Build URL with context parameter for dynamic content injection
                let previewUrl = `${APP_CONFIG.apiUrls.results}/${resultJobId}/preview/${encodeURIComponent(filePath)}`;
                if (contextFile) {
                    previewUrl += `?context_file=${encodeURIComponent(contextFile)}`;
                }
                
                console.log('Preview URL:', previewUrl);
                
                const response = await fetch(previewUrl);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Unknown error occurred';
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = response.statusText || `HTTP ${response.status}`;
                    }
                    
                    this.showToast('error', 'Preview Failed', `Unable to preview file: ${errorMessage}`);
                    return;
                }
                
                const previewData = await response.json();
                
                if (previewData.error) {
                    this.showToast('error', 'Preview Failed', previewData.error);
                    return;
                }
                
                // Check if this is a batch migration guide
                const isBatchGuide = filePath.includes('batch_migration_guide.md');
                
                this.showFilePreviewModal(previewData, filePath, isBatchGuide);
                this.showToast('success', 'Preview Loaded', `Successfully loaded preview for ${filePath.split('/').pop()}`);
                
            } catch (error) {
                console.error('Preview error:', error);
                this.showToast('error', 'Preview Error', `Failed to load preview: ${error.message}`);
            }
        }
        
        async previewUploadedFile(filePath, fileName) {
            try {
                console.log('Previewing uploaded file:', filePath, fileName);
                
                // Use upload job ID for previewing uploaded files
                const jobId = this.uploadJobId || 'unknown';
                
                // Build URL for uploaded file preview using the new API endpoint
                let previewUrl = `/rdlmigration/api/upload/${jobId}/preview/${encodeURIComponent(fileName)}`;
                
                console.log('Upload preview URL:', previewUrl);
                
                const response = await fetch(previewUrl);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Unknown error occurred';
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = response.statusText || `HTTP ${response.status}`;
                    }
                    
                    this.showToast('error', 'Preview Failed', `Unable to preview uploaded file: ${errorMessage}`);
                    return;
                }
                
                const previewData = await response.json();
                
                if (previewData.error) {
                    this.showToast('error', 'Preview Failed', previewData.error);
                    return;
                }
                
                this.showFilePreviewModal(previewData, fileName, false);
                this.showToast('success', 'Preview Loaded', `Successfully loaded preview for ${fileName}`);
                
            } catch (error) {
                console.error('Upload preview error:', error);
                this.showToast('error', 'Preview Error', `Failed to load preview: ${error.message}`);
            }
        }
        
        showFilePreviewModal(previewData, filePath, isBatchGuide = false) {
            // Create preview modal 
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            // Show info banner for batch guides
            let infoBanner = '';
            if (isBatchGuide) {
                infoBanner = `
                    <div style="background: #EFF6FF; padding: 1rem; border-bottom: 1px solid #DBEAFE; border-left: 4px solid #3B82F6;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="color: #3B82F6; font-size: 1.25rem;">🚀</div>
                            <div>
                                <div style="font-weight: 600; color: #1E40AF;">Token-Optimized Batch Migration Guide</div>
                                <div style="color: #1E40AF; font-size: 0.875rem;">This guide contains all file-specific details and migration steps for your entire batch</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Context switcher (only for batch guides)
            let contextSwitcher = '';
            if (isBatchGuide) {
                contextSwitcher = `
                    <div style="background: #F8FAFC; padding: 1rem; border-bottom: 1px solid #E2E8F0;">
                        <div style="color: #64748B; font-size: 0.875rem;">Context switching available for batch guides</div>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div style="background: #FFFFFF; width: 90%; max-width: 900px; height: 85%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="background: #002677; color: #FFFFFF; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">
                            <i class="fas fa-file-alt" style="margin-right: 0.5rem;"></i>
                            ${isBatchGuide ? '🚀 Smart Migration Guide' : `File Preview: ${filePath}`}
                        </h3>
                        <button id="preview-modal-close" style="background: none; border: none; color: #FFFFFF; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: background-color 0.2s;">×</button>
                    </div>
                    ${contextSwitcher}
                    <div id="previewContent" style="flex: 1; overflow: auto; padding: 1.5rem;">
                        ${this.renderFilePreview(previewData)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Enhanced modal close functionality
            const closeModal = () => {
                modal.remove();
                document.removeEventListener('keydown', handleKeydown);
            };
            
            // Close button handler
            const closeBtn = document.getElementById('preview-modal-close');
            if (closeBtn) {
                closeBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                };
                
                // Add hover effect
                closeBtn.onmouseenter = () => {
                    closeBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                };
                closeBtn.onmouseleave = () => {
                    closeBtn.style.backgroundColor = 'transparent';
                };
            }
            
            // Close on click outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            };
            
            // Close on Escape key
            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            };
            document.addEventListener('keydown', handleKeydown);
        }
        
        async switchGuideContext(contextFile, filePath) {
            try {
                // Show loading indicator
                const previewContent = document.getElementById('previewContent');
                if (previewContent) {
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div class="spinner" style="display: inline-block; width: 32px; height: 32px; border: 3px solid #E5E7EB; border-top: 3px solid #002677; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 1rem; color: #6B7280;">Loading context-specific guide...</p>
                        </div>
                    `;
                }
                
                // Fetch with new context
                const previewData = await this.getContextualPreview(filePath, contextFile);
                
                // Update content
                if (previewContent) {
                    previewContent.innerHTML = this.renderFilePreview(previewData);
                }
                
            } catch (error) {
                console.error('Context switch error:', error);
                const previewContent = document.getElementById('previewContent');
                if (previewContent) {
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #EF4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Failed to load contextual guide. Please try again.</p>
                        </div>
                    `;
                }
            }
        }
        
        async getContextualPreview(filePath, contextFile) {
            const resultJobId = this.currentJobId.replace('_migration', '');
            let previewUrl = `${APP_CONFIG.apiUrls.results}/${resultJobId}/preview/${filePath}`;
            if (contextFile) {
                previewUrl += `?context_file=${encodeURIComponent(contextFile)}`;
            }
            
            const response = await fetch(previewUrl);
            return await response.json();
        }
        
        renderFilePreview(previewData) {
            if (previewData.type === 'text') {
                return `
                    <pre style="background: #FAF8F2; padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.875rem; line-height: 1.5; color: #002677; margin: 0;">${previewData.content}</pre>
                `;
            } else if (previewData.type === 'html') {
                return previewData.content;
            } else if (previewData.type === 'image') {
                return `<img src="${previewData.content}" style="max-width: 100%; height: auto;" alt="File preview">`;
            } else {
                return `
                    <div style="text-align: center; padding: 2rem; color: #4B4D4F;">
                        <i class="fas fa-file" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h4 style="margin: 0.5rem 0; color: #002677;">Preview Not Available</h4>
                        <p style="margin: 0;">This file type cannot be previewed. Please download to view.</p>
                    </div>
                `;
            }
        }
        
        generateDemoAnalysisResults(selectedFiles) {
            // Generate demo data for testing when API is not available
            const pairs = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                for (let j = i + 1; j < selectedFiles.length; j++) {
                    const similarity = Math.floor(Math.random() * 100);
                    
                    pairs.push({
                        file1: selectedFiles[i].name.replace(/^[a-f0-9-]+_/, ''),
                        file2: selectedFiles[j].name.replace(/^[a-f0-9-]+_/, ''),
                        similarity: similarity,
                        details: {
                            data_source_similarity: Math.floor(Math.random() * 100),
                            filter_logic_similarity: Math.floor(Math.random() * 100),
                            business_purpose_similarity: Math.floor(Math.random() * 100),
                            calculation_similarity: Math.floor(Math.random() * 100),
                            parameter_similarity: Math.floor(Math.random() * 100)
                        },
                        sql_queries: {
                            file1_queries: [
                                `SELECT CustomerID, OrderDate, TotalAmount 
FROM Orders o 
INNER JOIN Customers c ON o.CustomerID = c.CustomerID 
WHERE OrderDate >= '2024-01-01' 
AND Status = 'Completed'
ORDER BY OrderDate DESC`
                            ],
                            file2_queries: [
                                `SELECT o.CustomerID, o.OrderDate, o.TotalAmount, c.CustomerName
FROM Orders o 
JOIN Customers c ON o.CustomerID = c.CustomerID 
WHERE o.OrderDate >= '2024-01-01' 
AND o.Status = 'Completed'
ORDER BY o.OrderDate DESC`
                            ]
                        }
                    });
                }
            }
            
            return { pairs, total_files: selectedFiles.length };
        }
        
        // OLD toggleSQLDetails method REMOVED to prevent conflicts
        // All SQL viewing now uses openSQLModal() overlay implementation
        
        // OLD toggleSQLComparison method REMOVED to prevent conflicts
        
        async exportPairAnalysis(pairIndex) {
            // Placeholder for export functionality
            await initializeAlertSystem().warning(
                `Export functionality for pair analysis ${pairIndex + 1} is currently under development. This feature will allow you to export detailed similarity analysis reports in multiple formats including PDF, Excel, and JSON.`,
                'Feature Coming Soon'
            );
        }
        
        getSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            return Array.from(checkboxes).map(cb => {
                const fileId = parseInt(cb.dataset.fileId);
                return this.uploadedFiles.find(f => f.id === fileId);
            }).filter(Boolean);
        }
        
        updateMigrationPreview() {
            const selectedMode = document.querySelector('input[name="migration-mode"]:checked')?.value;
            const selectedFiles = this.getSelectedFiles();
            const summaryElement = document.getElementById('migration-summary');
            
            if (selectedFiles.length === 0) {
                summaryElement.innerHTML = `
                    <div class="text-center" style="color: var(--dark-gray);">
                        Select files to see migration preview
                    </div>
                `;
                return;
            }
            
            if (selectedMode === 'individual') {
                summaryElement.innerHTML = `
                    <div class="grid grid-2" style="gap: 1.5rem;">
                        <div>
                            <div class="font-semibold mb-sm">Mode: Individual</div>
                            <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                ${selectedFiles.length} separate Power BI reports
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold mb-sm">Output Files</div>
                            <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                Power Query (.m) and DAX (.dax) files
                            </div>
                        </div>
                    </div>
                `;
            } else {
                summaryElement.innerHTML = `
                    <div class="grid grid-2" style="gap: 1.5rem;">
                        <div>
                            <div class="font-semibold mb-sm">Mode: Consolidated</div>
                            <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                Smart consolidation based on similarity
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold mb-sm">Estimated Output</div>
                            <div style="font-size: 0.875rem; color: var(--dark-gray);">
                                ~${Math.ceil(selectedFiles.length * 0.7)} consolidated reports
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        async startMigration() {
            const selectedFiles = this.getSelectedFiles();
            if (selectedFiles.length === 0) {
                this.showToast('warning', 'No files selected', 'Please select files to migrate');
                return;
            }
            
            const migrationMode = document.querySelector('input[name="migration-mode"]:checked')?.value;
            const enableConsolidation = document.getElementById('enable-consolidation').checked;
            const deepAnalysis = document.getElementById('deep-analysis').checked;
            
            try {
                // Prepare JSON data for migration
                const migrationData = {
                    files: selectedFiles.map(fileData => ({
                        name: fileData.name,
                        path: fileData.path,
                        size: fileData.size
                    })),
                    mode: migrationMode || 'individual',
                    consolidate: enableConsolidation,
                    deep_analysis: deepAnalysis
                };
                
                console.log('[DEBUG] Starting migration with data:', migrationData);
                
                const response = await fetch(APP_CONFIG.apiUrls.migrate, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(migrationData)
                });
                
                const result = await response.json();
                console.log('[DEBUG] Migration response:', result);
                
                if (result.success) {
                    this.currentJobId = result.job_id;
                    this.showProgressDashboard();
                    this.startProgressPolling();
                    this.showToast('success', 'Migration Started', `Job ID: ${result.job_id}`);
                } else {
                    this.showToast('error', 'Migration Failed', result.error || result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Migration error:', error);
                this.showToast('error', 'Migration Failed', 'Please try again');
            }
        }
        
        showProgressDashboard() {
            document.getElementById('progress-dashboard').classList.remove('hidden');
            document.getElementById('job-id-display').innerHTML = `
                <i class="fas fa-clock"></i>
                <span>Job: ${this.currentJobId}</span>
            `;
            
            // Scroll to progress dashboard
            document.getElementById('progress-dashboard').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        async showErrorDetails() {
            if (!this.currentJobId) {
                this.showToast('error', 'No Job Selected', 'No active migration job to show errors for');
                return;
            }
            
            try {
                const response = await fetch(`${window.config.baseUrl}/api/errors/${this.currentJobId}`);
                const errorData = await response.json();
                
                if (!response.ok) {
                    throw new Error(errorData.error || 'Failed to fetch error details');
                }
                
                this.displayErrorDetails(errorData);
                document.getElementById('error-details-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching error details:', error);
                this.showToast('error', 'Error Loading Details', 'Failed to load error details: ' + error.message);
            }
        }
        
        displayErrorDetails(errorData) {
            const contentDiv = document.getElementById('error-details-content');
            
            if (!errorData.errors || errorData.errors.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-700">No Errors Found</h3>
                        <p class="text-gray-500">This migration completed without any errors.</p>
                    </div>
                `;
                return;
            }
            
            const errorHtml = `
                <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Migration Summary
                    </h3>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">Job ID:</span>
                            <span class="text-gray-800">${errorData.job_id}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Status:</span>
                            <span class="text-red-600 font-medium">${errorData.status}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Total Errors:</span>
                            <span class="text-red-600 font-bold">${errorData.error_count}</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <h4 class="text-md font-semibold text-gray-800 mb-3">
                        <i class="fas fa-list mr-2"></i>
                        Error Details
                    </h4>
                    ${errorData.errors.map((error, index) => `
                        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-red-600 font-bold text-sm">${index + 1}</span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-900 mb-2">
                                        ${this.categorizeError(error)}
                                    </div>
                                    <div class="text-sm text-gray-700 bg-white p-3 rounded border font-mono">
                                        ${this.escapeHtml(error)}
                                    </div>
                                    <div class="mt-2 text-xs text-gray-500">
                                        ${this.getErrorSolution(error)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            contentDiv.innerHTML = errorHtml;
        }
        
        categorizeError(errorMessage) {
            if (errorMessage.includes('RDL parsing failed')) return '🔍 RDL File Parsing Error';
            if (errorMessage.includes('Power Query conversion failed')) return '⚡ Power Query Conversion Error';
            if (errorMessage.includes('DAX conversion failed')) return '📊 DAX Measures Generation Error';
            if (errorMessage.includes('Critical error processing')) return '💥 File Processing Error';
            if (errorMessage.includes('LLM API error') || errorMessage.includes('AI conversion failed')) return '🤖 AI Service Error';
            return '⚠️ General Migration Error';
        }
        
        getErrorSolution(errorMessage) {
            if (errorMessage.includes('RDL parsing failed')) {
                return '💡 Solution: Check if the RDL file is valid and not corrupted. Ensure it follows Microsoft RDL schema.';
            }
            if (errorMessage.includes('Power Query conversion failed')) {
                return '💡 Solution: Review the SQL query syntax. Complex queries may need manual adjustment.';
            }
            if (errorMessage.includes('DAX conversion failed')) {
                return '💡 Solution: Check table structure and field mappings. Some SSRS expressions may need manual conversion.';
            }
            if (errorMessage.includes('LLM API error') || errorMessage.includes('AI conversion failed')) {
                return '💡 Solution: Check your AI service configuration and API limits. Try again in a few minutes.';
            }
            return '💡 Solution: Review the error message above and check the migration logs for more details.';
        }
        
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        hideErrorDetails() {
            document.getElementById('error-details-modal').classList.add('hidden');
        }
        
        async downloadErrorLog() {
            if (!this.currentJobId) {
                this.showToast('error', 'No Job Selected', 'No active migration job to download errors for');
                return;
            }
            
            try {
                const response = await fetch(`${window.config.baseUrl}/api/errors/${this.currentJobId}`);
                const errorData = await response.json();
                
                if (!response.ok) {
                    throw new Error(errorData.error || 'Failed to fetch error details');
                }
                
                // Create error log content
                const logContent = `Migration Error Log
Job ID: ${errorData.job_id}
Status: ${errorData.status}
Generated: ${new Date().toISOString()}
Total Errors: ${errorData.error_count}

${'='.repeat(60)}
ERROR DETAILS
${'='.repeat(60)}

${errorData.errors.map((error, index) => `
Error #${index + 1}:
${'-'.repeat(40)}
${error}

`).join('')}

${'='.repeat(60)}
END OF LOG
${'='.repeat(60)}
`;
                
                // Create and download the file
                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `migration_errors_${this.currentJobId}_${new Date().toISOString().split('T')[0]}.log`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                this.showToast('success', 'Download Complete', 'Error log has been downloaded successfully');
                
            } catch (error) {
                console.error('Error downloading error log:', error);
                this.showToast('error', 'Download Failed', 'Failed to download error log: ' + error.message);
            }
        }
        
        showToast(type, title, message) {
            // Use the custom alert system's toast functionality
            initializeAlertSystem().showToast(type, title, message);
        }
        
        showSuccessNotification(message) {
            // Create and show a temporary success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(135deg, #10B981, #34D399);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 600;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    }
    
    // Migration mode selection
    function selectMigrationMode(mode) {
        document.querySelectorAll('.migration-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        event.currentTarget.classList.add('selected');
        document.querySelector(`input[value="${mode}"]`).checked = true;
        
        if (window.migrationManager) {
            migrationManager.updateMigrationPreview();
        }
    }
    
    // Navigation function using dynamic URLs
    function navigateTo(endpoint) {
        if (endpoint === '') {
            window.location.href = APP_CONFIG.pageUrls.dashboard;
        } else {
            window.location.href = APP_CONFIG.pageUrls[endpoint] || (APP_CONFIG.baseUrl + '/' + endpoint);
        }
    }
    
    // Initialize migration manager when page loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log('🚀 Initializing Migration Manager (External Access Compatible)');
        window.migrationManager = new MigrationManager();
    });
    </script>

    <!-- SQL Query Modal - Positioned at body level for proper separation -->
    <div id="sql-query-modal" class="sql-modal-overlay">
        <div class="sql-modal-container">
            <div class="sql-modal-header">
                <h3 class="sql-modal-title">
                    <i class="fas fa-code"></i>
                    SQL Query Comparison
                </h3>
                <button class="sql-modal-close" onclick="migrationManager.closeSQLModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="sql-modal-content" class="sql-modal-content">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div id="error-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-xl font-semibold" style="color: var(--navy-blue);">
                    <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
                    Migration Error Details
                </h2>
                <button onclick="migrationApp.hideErrorDetails()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-96">
                <div id="error-details-content" class="space-y-4">
                    <!-- Error details will be populated here -->
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end space-x-3">
                <button onclick="migrationApp.downloadErrorLog()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>Download Error Log
                </button>
                <button onclick="migrationApp.hideErrorDetails()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container for Migration Interface -->
    <div id="migration-toast-container" class="migration-toast-container"></div>

    <!-- Custom Alert System HTML Structure (Hidden by default) -->
    <div id="custom-alert-overlay" class="custom-alert-overlay">
        <div id="custom-alert" class="custom-alert">
            <div class="custom-alert-header">
                <div id="custom-alert-icon" class="custom-alert-icon">
                    <i id="custom-alert-icon-symbol" class="fas fa-info-circle"></i>
                </div>
                <h3 id="custom-alert-title" class="custom-alert-title">Alert</h3>
            </div>
            <div id="custom-alert-message" class="custom-alert-message">
                Alert message goes here
            </div>
            <div id="custom-alert-input-container" style="display: none;">
                <input type="text" id="custom-alert-input" class="custom-alert-input" placeholder="Enter value...">
            </div>
            <div id="custom-alert-actions" class="custom-alert-actions">
                <button id="custom-alert-cancel" class="custom-alert-btn secondary">Cancel</button>
                <button id="custom-alert-confirm" class="custom-alert-btn primary">OK</button>
            </div>
        </div>
    </div>

</body>
</html>